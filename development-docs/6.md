

# ÙØ§Ø² Û¶ â€” SmsUsageHandler (Ú©Ù†ØªØ±Ù„ Ù…ØµØ±Ù Ùˆ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª)

## Ø³Ø§Ø®ØªØ§Ø± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ùˆ ØªØºÛŒÛŒØ±ÛŒØ§ÙØªÙ‡

```
src/
â”œâ”€â”€ SmsManager.php                     â† ØªØºÛŒÛŒØ±: sendToTargets + resolveUsageHandler
â”œâ”€â”€ SmsServiceProvider.php             â† ØªØºÛŒÛŒØ± Ø¬Ø²Ø¦ÛŒ
â”œâ”€â”€ Support/
â”‚   â”œâ”€â”€ NullUsageHandler.php           â† Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±
â”‚   â””â”€â”€ DefaultUsageHandler.php        â† Ø¬Ø¯ÛŒØ¯
config/
â””â”€â”€ sms.php                            â† ØªØºÛŒÛŒØ±: usage settings per driver
tests/
â”œâ”€â”€ Unit/
â”‚   â””â”€â”€ Support/
â”‚       â”œâ”€â”€ NullUsageHandlerTest.php    â† Ø¬Ø¯ÛŒØ¯
â”‚       â””â”€â”€ DefaultUsageHandlerTest.php â† Ø¬Ø¯ÛŒØ¯
â””â”€â”€ Feature/
    â””â”€â”€ UsageHandlerTest.php            â† Ø¬Ø¯ÛŒØ¯
```

---

## Û±. `src/Support/DefaultUsageHandler.php`

```php
<?php

namespace Karnoweb\SmsSender\Support;

use Karnoweb\SmsSender\Contracts\SmsDriver;
use Karnoweb\SmsSender\Contracts\SmsUsageHandler;
use Karnoweb\SmsSender\Exceptions\DriverNotAvailableException;
use Karnoweb\SmsSender\Models\Sms;

/**
 * Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ú©Ù†ØªØ±Ù„ Ù…ØµØ±Ù Ø¯Ø±Ø§ÛŒÙˆØ±Ù‡Ø§ÛŒ SMS.
 *
 * Ø§ÛŒÙ† handler Ø³Ù‡ Ù†ÙˆØ¹ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯:
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Û±. ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù† Ø¯Ø±Ø§ÛŒÙˆØ± (enabled)
 * Û². Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø±ÙˆØ²Ø§Ù†Ù‡ (daily_limit)
 * Û³. Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ù…Ø§Ù‡Ø§Ù†Ù‡ (monthly_limit)
 *
 * ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø² config/sms.php Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯:
 * ```php
 * 'drivers' => [
 *     'kavenegar' => [
 *         'class'       => KavenegarDriver::class,
 *         'credentials' => [...],
 *         'usage' => [
 *             'enabled'       => true,
 *             'daily_limit'   => 1000,
 *             'monthly_limit' => 30000,
 *         ],
 *     ],
 * ],
 * ```
 *
 * Ø§Ú¯Ø± Ú©Ù„ÛŒØ¯ 'usage' Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø§ÛŒÙˆØ±ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¹Ù…Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
 *
 * ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ:
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Û±. Ø§Ø² Ø·Ø±ÛŒÙ‚ config:
 *    ```php
 *    // config/sms.php
 *    'usage_handler' => \Karnoweb\SmsSender\Support\DefaultUsageHandler::class,
 *    ```
 *
 * Û². Ø§Ø² Ø·Ø±ÛŒÙ‚ Container binding (Ø¯Ø± ServiceProvider Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†):
 *    ```php
 *    $this->app->bind(SmsUsageHandler::class, DefaultUsageHandler::class);
 *    ```
 */
class DefaultUsageHandler implements SmsUsageHandler
{
    /**
     * Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø¯Ø±Ø§ÛŒÙˆØ± Ù…Ø´Ø®Øµâ€ŒØ´Ø¯Ù‡ Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù‡Ø³Øª ÛŒØ§ Ø®ÛŒØ±.
     *
     * ØªØ±ØªÛŒØ¨ Ø¨Ø±Ø±Ø³ÛŒâ€ŒÙ‡Ø§:
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * Û±. Ø¢ÛŒØ§ Ø¯Ø±Ø§ÛŒÙˆØ± ÙØ¹Ø§Ù„ Ø§Ø³ØªØŸ (enabled !== false)
     * Û². Ø¢ÛŒØ§ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡ Ø±Ø¹Ø§ÛŒØª Ø´Ø¯Ù‡ØŸ
     * Û³. Ø¢ÛŒØ§ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø±Ø¹Ø§ÛŒØª Ø´Ø¯Ù‡ØŸ
     *
     * Ø§Ú¯Ø± Ù‡Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø´Ú©Ø³Øª Ø¨Ø®ÙˆØ±Ø¯ØŒ DriverNotAvailableException Ù¾Ø±ØªØ§Ø¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯
     * Ùˆ Ù…Ú©Ø§Ù†ÛŒØ²Ù… Failover Ø¯Ø±Ø§ÛŒÙˆØ± Ø¨Ø¹Ø¯ÛŒ Ø±Ø§ Ø§Ù…ØªØ­Ø§Ù† Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
     *
     * @param string    $driverName Ù†Ø§Ù… Ø¯Ø±Ø§ÛŒÙˆØ± (Ú©Ù„ÛŒØ¯ Ø¯Ø± config)
     * @param SmsDriver $driver     Ù†Ù…ÙˆÙ†Ù‡â€ŒÛŒ Ø³Ø§Ø®ØªÙ‡â€ŒØ´Ø¯Ù‡â€ŒÛŒ Ø¯Ø±Ø§ÛŒÙˆØ± (Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ ÙˆÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ interface)
     * @throws DriverNotAvailableException Ø§Ú¯Ø± Ø¯Ø±Ø§ÛŒÙˆØ± Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ø¨Ø§Ø´Ø¯
     */
    public function ensureUsable(string $driverName, SmsDriver $driver): void
    {
        $usageConfig = $this->getUsageConfig($driverName);

        // Ø§Ú¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª usage ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ â†’ Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª
        if ($usageConfig === null) {
            return;
        }

        $this->checkEnabled($driverName, $usageConfig);
        $this->checkDailyLimit($driverName, $usageConfig);
        $this->checkMonthlyLimit($driverName, $usageConfig);
    }

    /**
     * Ø®ÙˆØ§Ù†Ø¯Ù† ØªÙ†Ø¸ÛŒÙ…Ø§Øª usage Ø§Ø² config Ø¯Ø±Ø§ÛŒÙˆØ±.
     *
     * @param string $driverName Ù†Ø§Ù… Ø¯Ø±Ø§ÛŒÙˆØ±
     * @return array<string, mixed>|null ØªÙ†Ø¸ÛŒÙ…Ø§Øª usage ÛŒØ§ null Ø§Ú¯Ø± ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡
     */
    protected function getUsageConfig(string $driverName): ?array
    {
        $config = config("sms.drivers.{$driverName}.usage");

        // Ø§Ú¯Ø± Ø§ØµÙ„Ø§Ù‹ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ ÛŒØ§ Ø¢Ø±Ø§ÛŒÙ‡ Ù†ÛŒØ³Øª
        if (! is_array($config)) {
            return null;
        }

        return $config;
    }

    /**
     * Ø¨Ø±Ø±Ø³ÛŒ ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù† Ø¯Ø±Ø§ÛŒÙˆØ±.
     *
     * Ø§Ú¯Ø± 'enabled' ØµØ±Ø§Ø­ØªØ§Ù‹ false Ø¨Ø§Ø´Ø¯ØŒ Ø¯Ø±Ø§ÛŒÙˆØ± ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª.
     * Ø§Ú¯Ø± 'enabled' ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ ÙØ±Ø¶ Ø¨Ø± ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù† Ø§Ø³Øª.
     *
     * @param string               $driverName Ù†Ø§Ù… Ø¯Ø±Ø§ÛŒÙˆØ±
     * @param array<string, mixed> $usageConfig ØªÙ†Ø¸ÛŒÙ…Ø§Øª usage
     * @throws DriverNotAvailableException
     */
    protected function checkEnabled(string $driverName, array $usageConfig): void
    {
        // ÙÙ‚Ø· false ØµØ±ÛŒØ­ â†’ ØºÛŒØ±ÙØ¹Ø§Ù„
        // null, true, Ø¹Ø¯Ù… ØªØ¹Ø±ÛŒÙ â†’ ÙØ¹Ø§Ù„
        $enabled = $usageConfig['enabled'] ?? true;

        if ($enabled === false) {
            throw new DriverNotAvailableException(
                "SMS driver [{$driverName}] is disabled.",
            );
        }
    }

    /**
     * Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø±ÙˆØ²Ø§Ù†Ù‡.
     *
     * ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù…Ú©â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„â€ŒØ´Ø¯Ù‡â€ŒÛŒ Ø§Ù…Ø±ÙˆØ² Ø¨Ø§ Ø§ÛŒÙ† Ø¯Ø±Ø§ÛŒÙˆØ± Ø´Ù…Ø§Ø±Ø´ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
     * Ø§Ú¯Ø± Ø§Ø² daily_limit Ø¨ÛŒØ´ØªØ± Ø¨Ø§Ø´Ø¯ØŒ Exception Ù¾Ø±ØªØ§Ø¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
     *
     * @param string               $driverName Ù†Ø§Ù… Ø¯Ø±Ø§ÛŒÙˆØ±
     * @param array<string, mixed> $usageConfig ØªÙ†Ø¸ÛŒÙ…Ø§Øª usage
     * @throws DriverNotAvailableException
     */
    protected function checkDailyLimit(string $driverName, array $usageConfig): void
    {
        $dailyLimit = $usageConfig['daily_limit'] ?? null;

        // null ÛŒØ§ 0 â†’ Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡
        if (empty($dailyLimit)) {
            return;
        }

        $todayCount = $this->getTodayCount($driverName);

        if ($todayCount >= $dailyLimit) {
            throw new DriverNotAvailableException(
                "SMS driver [{$driverName}] daily limit reached ({$todayCount}/{$dailyLimit}).",
            );
        }
    }

    /**
     * Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ù…Ø§Ù‡Ø§Ù†Ù‡.
     *
     * ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù…Ú©â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„â€ŒØ´Ø¯Ù‡â€ŒÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ Ø¨Ø§ Ø§ÛŒÙ† Ø¯Ø±Ø§ÛŒÙˆØ± Ø´Ù…Ø§Ø±Ø´ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
     * Ø§Ú¯Ø± Ø§Ø² monthly_limit Ø¨ÛŒØ´ØªØ± Ø¨Ø§Ø´Ø¯ØŒ Exception Ù¾Ø±ØªØ§Ø¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
     *
     * @param string               $driverName Ù†Ø§Ù… Ø¯Ø±Ø§ÛŒÙˆØ±
     * @param array<string, mixed> $usageConfig ØªÙ†Ø¸ÛŒÙ…Ø§Øª usage
     * @throws DriverNotAvailableException
     */
    protected function checkMonthlyLimit(string $driverName, array $usageConfig): void
    {
        $monthlyLimit = $usageConfig['monthly_limit'] ?? null;

        // null ÛŒØ§ 0 â†’ Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù…Ø§Ù‡Ø§Ù†Ù‡
        if (empty($monthlyLimit)) {
            return;
        }

        $monthCount = $this->getMonthCount($driverName);

        if ($monthCount >= $monthlyLimit) {
            throw new DriverNotAvailableException(
                "SMS driver [{$driverName}] monthly limit reached ({$monthCount}/{$monthlyLimit}).",
            );
        }
    }

    /**
     * Ø´Ù…Ø§Ø±Ø´ Ù¾ÛŒØ§Ù…Ú©â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„â€ŒØ´Ø¯Ù‡â€ŒÛŒ Ø§Ù…Ø±ÙˆØ² Ø¨Ø±Ø§ÛŒ ÛŒÚ© Ø¯Ø±Ø§ÛŒÙˆØ±.
     *
     * ÙÙ‚Ø· Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² (Ø¨Ø± Ø§Ø³Ø§Ø³ created_at) Ø´Ù…Ø§Ø±Ø´ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
     * Ù‡Ù…Ù‡â€ŒÛŒ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ Ø´Ù…Ø§Ø±Ø´ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ (Ø­ØªÛŒ FAILED) Ú†ÙˆÙ† Ù†Ø´Ø§Ù†â€ŒØ¯Ù‡Ù†Ø¯Ù‡â€ŒÛŒ
     * ØªÙ„Ø§Ø´ Ø§Ø±Ø³Ø§Ù„ Ù‡Ø³ØªÙ†Ø¯ Ùˆ Ø¨Ø± Ù…ØµØ±Ù API ØªØ£Ø«ÛŒØ± Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±Ù†Ø¯.
     *
     * @param string $driverName Ù†Ø§Ù… Ø¯Ø±Ø§ÛŒÙˆØ±
     * @return int ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù…Ú©â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²
     */
    protected function getTodayCount(string $driverName): int
    {
        /** @var class-string<Sms> $modelClass */
        $modelClass = config('sms.model', Sms::class);

        return $modelClass::query()
            ->forDriver($driverName)
            ->whereDate('created_at', today())
            ->count();
    }

    /**
     * Ø´Ù…Ø§Ø±Ø´ Ù¾ÛŒØ§Ù…Ú©â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„â€ŒØ´Ø¯Ù‡â€ŒÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ Ø¨Ø±Ø§ÛŒ ÛŒÚ© Ø¯Ø±Ø§ÛŒÙˆØ±.
     *
     * Ø§Ø² Ø§Ø¨ØªØ¯Ø§ÛŒ Ù…Ø§Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¬Ø§Ø±ÛŒ ØªØ§ Ø§Ù„Ø§Ù† Ø´Ù…Ø§Ø±Ø´ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
     *
     * @param string $driverName Ù†Ø§Ù… Ø¯Ø±Ø§ÛŒÙˆØ±
     * @return int ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù…Ú©â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡
     */
    protected function getMonthCount(string $driverName): int
    {
        /** @var class-string<Sms> $modelClass */
        $modelClass = config('sms.model', Sms::class);

        return $modelClass::query()
            ->forDriver($driverName)
            ->where('created_at', '>=', now()->startOfMonth())
            ->count();
    }
}
```

---

## Û². `config/sms.php` (Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ù…Ù„)

```php
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Default SMS Driver
    |--------------------------------------------------------------------------
    */

    'default' => env('SMS_DRIVER', 'null'),

    /*
    |--------------------------------------------------------------------------
    | Failover Drivers
    |--------------------------------------------------------------------------
    */

    'failover' => [],

    /*
    |--------------------------------------------------------------------------
    | SMS Drivers
    |--------------------------------------------------------------------------
    |
    | Ù‡Ø± Ø¯Ø±Ø§ÛŒÙˆØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ÛŒÚ© Ú©Ù„ÛŒØ¯ 'usage' Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ Ø¨Ø±Ø§ÛŒ Ú©Ù†ØªØ±Ù„ Ù…ØµØ±Ù.
    | Ø§Ú¯Ø± 'usage' ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¹Ù…Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
    |
    | Ø³Ø§Ø®ØªØ§Ø± usage:
    |   'enabled'       => bool     ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶: true)
    |   'daily_limit'   => int|null Ø­Ø¯Ø§Ú©Ø«Ø± Ø§Ø±Ø³Ø§Ù„ Ø±ÙˆØ²Ø§Ù†Ù‡ (null = Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª)
    |   'monthly_limit' => int|null Ø­Ø¯Ø§Ú©Ø«Ø± Ø§Ø±Ø³Ø§Ù„ Ù…Ø§Ù‡Ø§Ù†Ù‡ (null = Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª)
    |
    */

    'drivers' => [

        'null' => [
            'class'       => \Karnoweb\SmsSender\Drivers\NullDriver::class,
            'credentials' => [],
            // Ø¨Ø¯ÙˆÙ† usage â†’ Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª
        ],

        // Ù†Ù…ÙˆÙ†Ù‡: Ø¯Ø±Ø§ÛŒÙˆØ± Ø¨Ø§ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª
        // 'kavenegar' => [
        //     'class'       => \App\SmsDrivers\KavenegarDriver::class,
        //     'credentials' => [
        //         'api_key' => env('KAVENEGAR_API_KEY'),
        //         'sender'  => env('KAVENEGAR_SENDER', '10008663'),
        //     ],
        //     'usage' => [
        //         'enabled'       => true,
        //         'daily_limit'   => 1000,
        //         'monthly_limit' => 30000,
        //     ],
        // ],

        // Ù†Ù…ÙˆÙ†Ù‡: Ø¯Ø±Ø§ÛŒÙˆØ± ØºÛŒØ±ÙØ¹Ø§Ù„ (Ø¨Ø±Ø§ÛŒ ØªØ¹Ù…ÛŒØ±Ø§Øª ÛŒØ§ ØªØ³Øª)
        // 'melipayamak' => [
        //     'class'       => \App\SmsDrivers\MelipayamakDriver::class,
        //     'credentials' => [...],
        //     'usage' => [
        //         'enabled' => false,
        //     ],
        // ],

    ],

    /*
    |--------------------------------------------------------------------------
    | SMS Log Model
    |--------------------------------------------------------------------------
    */

    'model' => \Karnoweb\SmsSender\Models\Sms::class,

    /*
    |--------------------------------------------------------------------------
    | SMS Table Name
    |--------------------------------------------------------------------------
    */

    'table' => 'sms_messages',

    /*
    |--------------------------------------------------------------------------
    | Usage Handler
    |--------------------------------------------------------------------------
    |
    | Ú©Ù„Ø§Ø³ Ù…Ø³Ø¦ÙˆÙ„ Ú©Ù†ØªØ±Ù„ Ù…ØµØ±Ù Ø¯Ø±Ø§ÛŒÙˆØ±Ù‡Ø§.
    |
    | Ù…Ù‚Ø§Ø¯ÛŒØ± Ù…Ù…Ú©Ù†:
    |   null                                                â†’ Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª (NullUsageHandler)
    |   \Karnoweb\SmsSender\Support\DefaultUsageHandler::class â†’ Ú©Ù†ØªØ±Ù„ Ù…ØµØ±Ù Ø¨Ø± Ø§Ø³Ø§Ø³ config
    |   \App\MyCustomHandler::class                         â†’ handler Ø³ÙØ§Ø±Ø´ÛŒ Ø´Ù…Ø§
    |
    | Ù†Ú©ØªÙ‡: handler Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ†ØªØ±ÙÛŒØ³ SmsUsageHandler Ø±Ø§ implement Ú©Ù†Ø¯.
    |
    */

    'usage_handler' => null,

];
```

---

## Û³. `src/SmsManager.php` (ØªØºÛŒÛŒØ±Ø§Øª ÙØ§Ø² Û¶)

> ÙÙ‚Ø· Ù…ØªØ¯Ù‡Ø§ÛŒ ØªØºÛŒÛŒØ±â€ŒÛŒØ§ÙØªÙ‡ Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.

```php
<?php

namespace Karnoweb\SmsSender;

use Illuminate\Contracts\Container\Container;
use Karnoweb\SmsSender\Contracts\DeliveryReportFetcher;
use Karnoweb\SmsSender\Contracts\SmsDriver;
use Karnoweb\SmsSender\Contracts\SmsUsageHandler;
use Karnoweb\SmsSender\Enums\SmsSendStatusEnum;
use Karnoweb\SmsSender\Enums\SmsTemplateEnum;
use Karnoweb\SmsSender\Exceptions\DriverConnectionException;
use Karnoweb\SmsSender\Exceptions\DriverNotAvailableException;
use Karnoweb\SmsSender\Exceptions\InvalidDriverConfigurationException;
use Karnoweb\SmsSender\Models\Sms;
use Karnoweb\SmsSender\Support\NullUsageHandler;

/**
 * Ù…Ø¯ÛŒØ± Ø§ØµÙ„ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…Ú© â€” Builder / Facade Ø³Ø·Ø­ Ø¨Ø§Ù„Ø§.
 *
 * Ù…Ø³Ø¦ÙˆÙ„ÛŒØªâ€ŒÙ‡Ø§:
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Û±. Ø±Ø§Ø¨Ø· Fluent Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù…Ú©
 * Û². Resolve Ú©Ø±Ø¯Ù† Ø¯Ø±Ø§ÛŒÙˆØ±Ù‡Ø§ Ø§Ø² Config Ùˆ Container
 * Û³. Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Failover Ø®ÙˆØ¯Ú©Ø§Ø±
 * Û´. Ø«Ø¨Øª Ù„Ø§Ú¯ Ù‡Ø± Ù¾ÛŒØ§Ù…Ú©
 * Ûµ. Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª ØªØ­ÙˆÛŒÙ„
 * Û¶. Ú©Ù†ØªØ±Ù„ Ù…ØµØ±Ù Ø§Ø² Ø·Ø±ÛŒÙ‚ UsageHandler
 */
class SmsManager
{
    // â”€â”€â”€ Builder State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    /** @var array<int, string> */
    protected array $toNumbers = [];

    protected ?string $messageText = null;

    protected ?string $templateText = null;

    protected ?string $templateName = null;

    /** @var array<string, string> */
    protected array $inputs = [];

    protected SmsUsageHandler $usageHandler;

    public function __construct(
        protected readonly Container $container,
    ) {
        $this->usageHandler = $this->resolveUsageHandler();
    }

    public static function instance(): static
    {
        /** @var static $instance */
        $instance = app(static::class);

        return $instance;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  BUILDER â€” ØªÙ†Ø¸ÛŒÙ… Ù¾ÛŒØ§Ù…
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    public function message(string $message): static
    {
        $this->messageText = $message;

        return $this;
    }

    public function otp(SmsTemplateEnum $template): static
    {
        $this->templateText = $template->value;
        $this->templateName = $template->name;

        return $this;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  BUILDER â€” ØªÙ†Ø¸ÛŒÙ… Inputs
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    public function input(string $key, string $value): static
    {
        $this->inputs[$key] = $value;

        return $this;
    }

    public function inputs(array $inputs): static
    {
        $this->inputs = array_merge($this->inputs, $inputs);

        return $this;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  BUILDER â€” ØªÙ†Ø¸ÛŒÙ… Ú¯ÛŒØ±Ù†Ø¯Ù‡â€ŒÙ‡Ø§
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    public function number(string $phone): static
    {
        $this->toNumbers[] = $phone;

        return $this;
    }

    public function numbers(array $phones): static
    {
        foreach ($phones as $phone) {
            $this->toNumbers[] = (string) $phone;
        }

        return $this;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SEND
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    public function send(): void
    {
        try {
            $targets = $this->resolveTargets();

            if (empty($targets)) {
                throw new InvalidDriverConfigurationException(
                    'No recipients provided.',
                );
            }

            $message = $this->resolveMessage();

            if ($message === null) {
                throw new InvalidDriverConfigurationException(
                    'No message or template provided.',
                );
            }

            $this->sendToTargets($targets, $message);
        } finally {
            $this->reset();
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CHECK STATUS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    public function checkStatus(): array
    {
        try {
            $targets = $this->resolveTargets();

            if (empty($targets)) {
                throw new InvalidDriverConfigurationException(
                    'No recipients provided to check status.',
                );
            }

            return $this->fetchStatusForTargets($targets);
        } finally {
            $this->reset();
        }
    }

    protected function fetchStatusForTargets(array $phoneNumbers): array
    {
        /** @var class-string<Sms> $modelClass */
        $modelClass = config('sms.model', Sms::class);

        $results = [];

        foreach ($phoneNumbers as $phone) {
            $records = $modelClass::query()
                ->forPhone($phone)
                ->checkable()
                ->get();

            foreach ($records as $record) {
                $results[] = $this->checkSingleRecord($record);
            }
        }

        return $results;
    }

    protected function checkSingleRecord(Sms $record): array
    {
        $baseResult = [
            'sms_id'              => $record->id,
            'phone'               => $record->phone,
            'driver'              => $record->driver,
            'provider_message_id' => $record->provider_message_id,
            'old_status'          => $record->status->value,
        ];

        if (! $record->hasProviderMessageId()) {
            return array_merge($baseResult, [
                'skipped' => true,
                'reason'  => 'No provider_message_id available.',
            ]);
        }

        try {
            $driver = $this->resolveDriver($record->driver);

            if (! $driver instanceof DeliveryReportFetcher) {
                return array_merge($baseResult, [
                    'skipped' => true,
                    'reason'  => 'Driver does not support delivery reports.',
                ]);
            }

            $report    = $driver->fetchDeliveryReport($record->provider_message_id);
            $newStatus = $report['status'] ?? 'unknown';

            $this->updateRecordStatus($record, $newStatus);

            return array_merge($baseResult, [
                'new_status' => $newStatus,
            ]);

        } catch (\Throwable $e) {
            return array_merge($baseResult, [
                'error' => $e->getMessage(),
            ]);
        }
    }

    protected function updateRecordStatus(Sms $record, string $newStatus): void
    {
        match ($newStatus) {
            'delivered' => $record->markAsDelivered(),
            'failed'    => $record->markAsFailed('Reported as failed by provider.'),
            default     => null,
        };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  RESOLVE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    protected function resolveTargets(): array
    {
        return array_values(array_unique($this->toNumbers));
    }

    protected function resolveMessage(): ?string
    {
        if ($this->messageText !== null) {
            return $this->messageText;
        }

        if ($this->templateText !== null) {
            return $this->compileTemplate($this->templateText, $this->inputs);
        }

        return null;
    }

    protected function compileTemplate(string $template, array $inputs = []): string
    {
        if (empty($inputs)) {
            return $template;
        }

        $search  = [];
        $replace = [];

        foreach ($inputs as $key => $value) {
            $search[]  = '{' . $key . '}';
            $replace[] = (string) $value;
        }

        return str_replace($search, $replace, $template);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  DRIVER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    protected function getDriverOrder(): array
    {
        $default  = config('sms.default');
        $failover = config('sms.failover', []);

        $order = [];

        if (! empty($default)) {
            $order[] = $default;
        }

        if (is_array($failover)) {
            $order = array_merge($order, $failover);
        }

        $order = array_values(array_unique($order));

        if (empty($order)) {
            throw new InvalidDriverConfigurationException(
                'No SMS driver configured. Set SMS_DRIVER in .env or update config/sms.php.',
            );
        }

        return $order;
    }

    protected function resolveDriver(string $name): SmsDriver
    {
        $driverConfig = config("sms.drivers.{$name}");

        if (! is_array($driverConfig) || empty($driverConfig)) {
            throw new InvalidDriverConfigurationException(
                "SMS driver [{$name}] is not defined in config/sms.php.",
            );
        }

        $class = $driverConfig['class'] ?? null;

        if (empty($class) || ! is_string($class)) {
            throw new InvalidDriverConfigurationException(
                "Driver class for [{$name}] is not specified in config/sms.php.",
            );
        }

        if (! class_exists($class)) {
            throw new InvalidDriverConfigurationException(
                "Driver class [{$class}] for [{$name}] does not exist.",
            );
        }

        $credentials = $driverConfig['credentials'] ?? [];

        /** @var SmsDriver $driver */
        $driver = $this->container->make($class, [
            'config' => $credentials,
        ]);

        if (! $driver instanceof SmsDriver) {
            throw new InvalidDriverConfigurationException(
                "Driver [{$class}] must implement " . SmsDriver::class . '.',
            );
        }

        return $driver;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SEND TO TARGETS â€” Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Failover
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…Ú© Ø¨Ù‡ Ù„ÛŒØ³Øª Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…Ú©Ø§Ù†ÛŒØ²Ù… Failover.
     *
     * Exception Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¨Ø§Ø¹Ø« Failover Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯:
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * Û±. InvalidDriverConfigurationException â†’ Ù…Ø´Ú©Ù„ config Ø¯Ø±Ø§ÛŒÙˆØ±
     * Û². DriverConnectionException           â†’ Ù…Ø´Ú©Ù„ Ø§Ø±ØªØ¨Ø§Ø·ÛŒ Ø¨Ø§ Ø³Ø±ÙˆÛŒØ³â€ŒØ¯Ù‡Ù†Ø¯Ù‡
     * Û³. DriverNotAvailableException         â†’ Ø¯Ø±Ø§ÛŒÙˆØ± ØºÛŒØ±ÙØ¹Ø§Ù„ ÛŒØ§ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù…ØµØ±Ù (Ø§Ø² UsageHandler)
     *
     * Ø³Ø§ÛŒØ± Exception Ù‡Ø§ (bug) Ø¨Ø¯ÙˆÙ† Failover Ø¨Ù‡ Ø¨Ø§Ù„Ø§ bubble Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯.
     *
     * @param array<int, string> $phoneNumbers
     * @param string             $message
     * @throws DriverNotAvailableException
     */
    protected function sendToTargets(array $phoneNumbers, string $message): void
    {
        $driverOrder   = $this->getDriverOrder();
        $lastException = null;

        foreach ($driverOrder as $driverName) {
            try {
                $driver = $this->resolveDriver($driverName);

                // â”€â”€ Ø¨Ø±Ø±Ø³ÛŒ Ù…ØµØ±Ù/ÙØ¹Ø§Ù„â€ŒØ¨ÙˆØ¯Ù† â”€â”€
                // Ø§Ú¯Ø± Ø¯Ø±Ø§ÛŒÙˆØ± ØºÛŒØ±ÙØ¹Ø§Ù„ ÛŒØ§ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù…ØµØ±Ù ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ
                // UsageHandler ÛŒÚ© DriverNotAvailableException Ù¾Ø±ØªØ§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
                // Ùˆ Failover Ø¨Ù‡ Ø¯Ø±Ø§ÛŒÙˆØ± Ø¨Ø¹Ø¯ÛŒ Ø³ÙˆØ¦ÛŒÚ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
                $this->usageHandler->ensureUsable($driverName, $driver);

                $this->sendWithDriver($driverName, $driver, $phoneNumbers, $message);

                return;

            } catch (InvalidDriverConfigurationException $e) {
                // âš ï¸ Ù…Ø´Ú©Ù„ config â†’ Ø¯Ø±Ø§ÛŒÙˆØ± Ø¨Ø¹Ø¯ÛŒ
                $lastException = $e;
                continue;

            } catch (DriverConnectionException $e) {
                // âš ï¸ Ù…Ø´Ú©Ù„ Ø§Ø±ØªØ¨Ø§Ø·ÛŒ â†’ Ø¯Ø±Ø§ÛŒÙˆØ± Ø¨Ø¹Ø¯ÛŒ
                $lastException = $e;
                continue;

            } catch (DriverNotAvailableException $e) {
                // âš ï¸ Ø¯Ø±Ø§ÛŒÙˆØ± ØºÛŒØ±ÙØ¹Ø§Ù„ ÛŒØ§ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù…ØµØ±Ù â†’ Ø¯Ø±Ø§ÛŒÙˆØ± Ø¨Ø¹Ø¯ÛŒ
                // Ø§ÛŒÙ† Exception ØªÙˆØ³Ø· UsageHandler Ù¾Ø±ØªØ§Ø¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                $lastException = $e;
                continue;
            }

            // ğŸ”´ Ø³Ø§ÛŒØ± Exception Ù‡Ø§: bubble up (Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ bug)
        }

        throw new DriverNotAvailableException(
            message:  'No SMS drivers are available to send messages.',
            previous: $lastException,
        );
    }

    protected function sendWithDriver(
        string $driverName,
        SmsDriver $driver,
        array $phoneNumbers,
        string $message,
    ): void {
        /** @var class-string<Sms> $modelClass */
        $modelClass = config('sms.model', Sms::class);

        foreach ($phoneNumbers as $phoneNumber) {
            /** @var Sms $record */
            $record = $modelClass::create([
                'driver'   => $driverName,
                'template' => $this->templateName,
                'inputs'   => ! empty($this->inputs) ? $this->inputs : null,
                'phone'    => $phoneNumber,
                'message'  => $message,
                'status'   => SmsSendStatusEnum::PENDING,
            ]);

            try {
                $driver->send($phoneNumber, $message);
                $record->markAsSent();

            } catch (DriverConnectionException $e) {
                $record->markAsFailed($e->getMessage());
                throw $e;
            }
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  USAGE HANDLER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Resolve Ú©Ø±Ø¯Ù† UsageHandler.
     *
     * ØªØ±ØªÛŒØ¨ Ø§ÙˆÙ„ÙˆÛŒØª:
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * Û±. Ø§Ú¯Ø± Ø¯Ø± config Ú©Ù„Ø§Ø³ Ù…Ø´Ø®Øµ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ â†’ Ø§Ø² Ø¢Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
     * Û². Ø§Ú¯Ø± Ø¯Ø± Container Ø¨Ù‡ ØµÙˆØ±Øª Ù…Ø³ØªÙ‚ÛŒÙ… bind Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ â†’ Ø§Ø² Ø¢Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
     * Û³. Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª â†’ NullUsageHandler (Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª)
     *
     * Ø§ÛŒÙ† ØªØ±ØªÛŒØ¨ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø¬Ø§Ø²Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ø¨Ù‡ Û³ Ø±ÙˆØ´ UsageHandler Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†Ø¯:
     * - Ø§Ø² Ø·Ø±ÛŒÙ‚ config/sms.php
     * - Ø§Ø² Ø·Ø±ÛŒÙ‚ Container binding Ø¯Ø± ServiceProvider
     * - ÛŒØ§ Ø§ØµÙ„Ø§Ù‹ ØªÙ†Ø¸ÛŒÙ… Ù†Ú©Ù†Ø¯ (Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª)
     */
    protected function resolveUsageHandler(): SmsUsageHandler
    {
        // â”€â”€ Ø§ÙˆÙ„ÙˆÛŒØª Û±: Ø§Ø² config â”€â”€
        $handlerClass = config('sms.usage_handler');

        if (! empty($handlerClass) && is_string($handlerClass)) {
            return $this->container->make($handlerClass);
        }

        // â”€â”€ Ø§ÙˆÙ„ÙˆÛŒØª Û²: Ø§Ø² Container binding â”€â”€
        if ($this->container->bound(SmsUsageHandler::class)) {
            return $this->container->make(SmsUsageHandler::class);
        }

        // â”€â”€ Ø§ÙˆÙ„ÙˆÛŒØª Û³: Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª â”€â”€
        return new NullUsageHandler();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  RESET
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    protected function reset(): void
    {
        $this->toNumbers    = [];
        $this->messageText  = null;
        $this->templateText = null;
        $this->templateName = null;
        $this->inputs       = [];
    }
}
```

---

## Û´. `tests/Unit/Support/NullUsageHandlerTest.php`

```php
<?php

namespace Karnoweb\SmsSender\Tests\Unit\Support;

use Karnoweb\SmsSender\Contracts\SmsUsageHandler;
use Karnoweb\SmsSender\Drivers\NullDriver;
use Karnoweb\SmsSender\Support\NullUsageHandler;
use Karnoweb\SmsSender\Tests\TestCase;

/**
 * ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ NullUsageHandler.
 *
 * NullUsageHandler Ù‡ÛŒÚ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØªÛŒ Ø§Ø¹Ù…Ø§Ù„ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯ (Null Object Pattern).
 */
class NullUsageHandlerTest extends TestCase
{
    public function test_implements_interface(): void
    {
        $handler = new NullUsageHandler();

        $this->assertInstanceOf(SmsUsageHandler::class, $handler);
    }

    public function test_ensure_usable_never_throws(): void
    {
        $handler = new NullUsageHandler();
        $driver  = new NullDriver();

        // Ù†Ø¨Ø§ÛŒØ¯ Ù‡ÛŒÚ† Exception Ù¾Ø±ØªØ§Ø¨ Ø´ÙˆØ¯
        $handler->ensureUsable('any_driver', $driver);
        $handler->ensureUsable('nonexistent', $driver);
        $handler->ensureUsable('', $driver);

        $this->assertTrue(true); // Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ø§ÛŒÙ†Ø¬Ø§ = Ù…ÙˆÙÙ‚ÛŒØª
    }
}
```

---

## Ûµ. `tests/Unit/Support/DefaultUsageHandlerTest.php`

```php
<?php

namespace Karnoweb\SmsSender\Tests\Unit\Support;

use Illuminate\Foundation\Testing\RefreshDatabase;
use Karnoweb\SmsSender\Contracts\SmsUsageHandler;
use Karnoweb\SmsSender\Drivers\NullDriver;
use Karnoweb\SmsSender\Enums\SmsSendStatusEnum;
use Karnoweb\SmsSender\Exceptions\DriverNotAvailableException;
use Karnoweb\SmsSender\Models\Sms as SmsModel;
use Karnoweb\SmsSender\Support\DefaultUsageHandler;
use Karnoweb\SmsSender\Tests\TestCase;

/**
 * ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ DefaultUsageHandler.
 *
 * Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§:
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Û±. Ø¨Ø¯ÙˆÙ† ØªÙ†Ø¸ÛŒÙ…Ø§Øª usage â†’ Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª
 * Û². enabled = false â†’ ØºÛŒØ±ÙØ¹Ø§Ù„
 * Û³. enabled = true â†’ ÙØ¹Ø§Ù„
 * Û´. daily_limit â†’ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡
 * Ûµ. monthly_limit â†’ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù…Ø§Ù‡Ø§Ù†Ù‡
 * Û¶. ØªØ±Ú©ÛŒØ¨ Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§
 */
class DefaultUsageHandlerTest extends TestCase
{
    use RefreshDatabase;

    private DefaultUsageHandler $handler;

    protected function defineDatabaseMigrations(): void
    {
        $this->loadMigrationsFrom(__DIR__ . '/../../../database/migrations');
    }

    protected function setUp(): void
    {
        parent::setUp();

        $this->handler = new DefaultUsageHandler();
    }

    /**
     * Helper: Ø³Ø§Ø®Øª Ø±Ú©ÙˆØ±Ø¯ Ù¾ÛŒØ§Ù…Ú© Ø¨Ø±Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù…ØµØ±Ù.
     */
    private function createSmsRecord(string $driver, array $overrides = []): SmsModel
    {
        return SmsModel::create(array_merge([
            'driver'  => $driver,
            'phone'   => '09120000000',
            'message' => 'Test',
            'status'  => SmsSendStatusEnum::SENT,
        ], $overrides));
    }

    /**
     * Helper: Ø³Ø§Ø®Øª Ú†Ù†Ø¯ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ Ù¾ÛŒØ§Ù…Ú©.
     */
    private function createMultipleSmsRecords(string $driver, int $count, array $overrides = []): void
    {
        for ($i = 0; $i < $count; $i++) {
            $this->createSmsRecord($driver, $overrides);
        }
    }

    // â”€â”€â”€ Scenario 1: No usage config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_no_usage_config_allows_all(): void
    {
        // Ø¯Ø±Ø§ÛŒÙˆØ±ÛŒ Ú©Ù‡ Ø§ØµÙ„Ø§Ù‹ Ú©Ù„ÛŒØ¯ usage Ù†Ø¯Ø§Ø±Ø¯
        config(['sms.drivers.test_driver' => [
            'class'       => NullDriver::class,
            'credentials' => [],
            // Ø¨Ø¯ÙˆÙ† 'usage'
        ]]);

        $driver = new NullDriver();

        // Ù†Ø¨Ø§ÛŒØ¯ Exception Ù¾Ø±ØªØ§Ø¨ Ø´ÙˆØ¯
        $this->handler->ensureUsable('test_driver', $driver);

        $this->assertTrue(true);
    }

    public function test_empty_usage_config_allows_all(): void
    {
        config(['sms.drivers.test_driver' => [
            'class'       => NullDriver::class,
            'credentials' => [],
            'usage'       => [],
        ]]);

        // Ø¢Ø±Ø§ÛŒÙ‡â€ŒÛŒ Ø®Ø§Ù„ÛŒ Ù‡Ù†ÙˆØ² Ø¢Ø±Ø§ÛŒÙ‡ Ø§Ø³Øª â†’ Ø¨Ø±Ø±Ø³ÛŒâ€ŒÙ‡Ø§ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
        // Ø§Ù…Ø§ Ú†ÙˆÙ† enabled/daily_limit/monthly_limit ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ØŒ Ù‡Ù…Ù‡ pass Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
        $this->handler->ensureUsable('test_driver', new NullDriver());

        $this->assertTrue(true);
    }

    // â”€â”€â”€ Scenario 2: Enabled/Disabled â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_disabled_driver_throws_exception(): void
    {
        config(['sms.drivers.test_driver' => [
            'class'       => NullDriver::class,
            'credentials' => [],
            'usage'       => [
                'enabled' => false,
            ],
        ]]);

        $this->expectException(DriverNotAvailableException::class);
        $this->expectExceptionMessage('disabled');

        $this->handler->ensureUsable('test_driver', new NullDriver());
    }

    public function test_enabled_driver_passes(): void
    {
        config(['sms.drivers.test_driver' => [
            'class'       => NullDriver::class,
            'credentials' => [],
            'usage'       => [
                'enabled' => true,
            ],
        ]]);

        $this->handler->ensureUsable('test_driver', new NullDriver());

        $this->assertTrue(true);
    }

    public function test_enabled_not_set_defaults_to_true(): void
    {
        // enabled ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ â†’ ÙØ±Ø¶ Ø¨Ø± ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù†
        config(['sms.drivers.test_driver' => [
            'class'       => NullDriver::class,
            'credentials' => [],
            'usage'       => [
                'daily_limit' => 100,
                // Ø¨Ø¯ÙˆÙ† 'enabled'
            ],
        ]]);

        $this->handler->ensureUsable('test_driver', new NullDriver());

        $this->assertTrue(true);
    }

    // â”€â”€â”€ Scenario 3: Daily Limit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_under_daily_limit_passes(): void
    {
        config(['sms.drivers.test_driver' => [
            'class'       => NullDriver::class,
            'credentials' => [],
            'usage'       => [
                'daily_limit' => 10,
            ],
        ]]);

        // Ø³Ø§Ø®Øª Ûµ Ø±Ú©ÙˆØ±Ø¯ (Ø²ÛŒØ± Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Û±Û°)
        $this->createMultipleSmsRecords('test_driver', 5);

        $this->handler->ensureUsable('test_driver', new NullDriver());

        $this->assertTrue(true);
    }

    public function test_at_daily_limit_throws_exception(): void
    {
        config(['sms.drivers.test_driver' => [
            'class'       => NullDriver::class,
            'credentials' => [],
            'usage'       => [
                'daily_limit' => 5,
            ],
        ]]);

        // Ø³Ø§Ø®Øª Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ûµ Ø±Ú©ÙˆØ±Ø¯ (Ø¨Ø±Ø§Ø¨Ø± Ù…Ø­Ø¯ÙˆØ¯ÛŒØª)
        $this->createMultipleSmsRecords('test_driver', 5);

        $this->expectException(DriverNotAvailableException::class);
        $this->expectExceptionMessage('daily limit');

        $this->handler->ensureUsable('test_driver', new NullDriver());
    }

    public function test_over_daily_limit_throws_exception(): void
    {
        config(['sms.drivers.test_driver' => [
            'class'       => NullDriver::class,
            'credentials' => [],
            'usage'       => [
                'daily_limit' => 5,
            ],
        ]]);

        // Ø³Ø§Ø®Øª Û· Ø±Ú©ÙˆØ±Ø¯ (Ø¨Ø§Ù„Ø§ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ûµ)
        $this->createMultipleSmsRecords('test_driver', 7);

        $this->expectException(DriverNotAvailableException::class);
        $this->expectExceptionMessage('daily limit');

        $this->handler->ensureUsable('test_driver', new NullDriver());
    }

    public function test_daily_limit_null_means_no_limit(): void
    {
        config(['sms.drivers.test_driver' => [
            'class'       => NullDriver::class,
            'credentials' => [],
            'usage'       => [
                'daily_limit' => null,
            ],
        ]]);

        $this->createMultipleSmsRecords('test_driver', 1000);

        $this->handler->ensureUsable('test_driver', new NullDriver());

        $this->assertTrue(true);
    }

    public function test_daily_limit_only_counts_today(): void
    {
        config(['sms.drivers.test_driver' => [
            'class'       => NullDriver::class,
            'credentials' => [],
            'usage'       => [
                'daily_limit' => 5,
            ],
        ]]);

        // Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø¯ÛŒØ±ÙˆØ² â€” Ù†Ø¨Ø§ÛŒØ¯ Ø´Ù…Ø§Ø±Ø´ Ø´ÙˆÙ†Ø¯
        $this->createMultipleSmsRecords('test_driver', 10, [
            'created_at' => now()->subDay(),
        ]);

        // Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² â€” Û³ ØªØ§ (Ø²ÛŒØ± Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ûµ)
        $this->createMultipleSmsRecords('test_driver', 3);

        $this->handler->ensureUsable('test_driver', new NullDriver());

        $this->assertTrue(true);
    }

    public function test_daily_limit_counts_all_statuses(): void
    {
        config(['sms.drivers.test_driver' => [
            'class'       => NullDriver::class,
            'credentials' => [],
            'usage'       => [
                'daily_limit' => 5,
            ],
        ]]);

        // Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø¨Ø§ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù â€” Ù‡Ù…Ù‡ Ø¨Ø§ÛŒØ¯ Ø´Ù…Ø§Ø±Ø´ Ø´ÙˆÙ†Ø¯
        $this->createSmsRecord('test_driver', ['status' => SmsSendStatusEnum::SENT]);
        $this->createSmsRecord('test_driver', ['status' => SmsSendStatusEnum::FAILED]);
        $this->createSmsRecord('test_driver', ['status' => SmsSendStatusEnum::PENDING]);
        $this->createSmsRecord('test_driver', ['status' => SmsSendStatusEnum::DELIVERED]);
        $this->createSmsRecord('test_driver', ['status' => SmsSendStatusEnum::SENT]);

        $this->expectException(DriverNotAvailableException::class);

        $this->handler->ensureUsable('test_driver', new NullDriver());
    }

    public function test_daily_limit_only_counts_same_driver(): void
    {
        config([
            'sms.drivers.driver_a' => [
                'class'       => NullDriver::class,
                'credentials' => [],
                'usage'       => ['daily_limit' => 5],
            ],
            'sms.drivers.driver_b' => [
                'class'       => NullDriver::class,
                'credentials' => [],
            ],
        ]);

        // Û±Û° Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø±Ø§ÛŒ driver_b â€” Ù†Ø¨Ø§ÛŒØ¯ Ø±ÙˆÛŒ driver_a ØªØ£Ø«ÛŒØ± Ø¨Ú¯Ø°Ø§Ø±Ø¯
        $this->createMultipleSmsRecords('driver_b', 10);

        // Û² Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø±Ø§ÛŒ driver_a (Ø²ÛŒØ± Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ûµ)
        $this->createMultipleSmsRecords('driver_a', 2);

        $this->handler->ensureUsable('driver_a', new NullDriver());

        $this->assertTrue(true);
    }

    // â”€â”€â”€ Scenario 4: Monthly Limit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_under_monthly_limit_passes(): void
    {
        config(['sms.drivers.test_driver' => [
            'class'       => NullDriver::class,
            'credentials' => [],
            'usage'       => [
                'monthly_limit' => 100,
            ],
        ]]);

        $this->createMultipleSmsRecords('test_driver', 50);

        $this->handler->ensureUsable('test_driver', new NullDriver());

        $this->assertTrue(true);
    }

    public function test_at_monthly_limit_throws_exception(): void
    {
        config(['sms.drivers.test_driver' => [
            'class'       => NullDriver::class,
            'credentials' => [],
            'usage'       => [
                'monthly_limit' => 10,
            ],
        ]]);

        $this->createMultipleSmsRecords('test_driver', 10);

        $this->expectException(DriverNotAvailableException::class);
        $this->expectExceptionMessage('monthly limit');

        $this->handler->ensureUsable('test_driver', new NullDriver());
    }

    public function test_monthly_limit_only_counts_current_month(): void
    {
        config(['sms.drivers.test_driver' => [
            'class'       => NullDriver::class,
            'credentials' => [],
            'usage'       => [
                'monthly_limit' => 10,
            ],
        ]]);

        // Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù…Ø§Ù‡ Ù‚Ø¨Ù„ â€” Ù†Ø¨Ø§ÛŒØ¯ Ø´Ù…Ø§Ø±Ø´ Ø´ÙˆÙ†Ø¯
        $this->createMultipleSmsRecords('test_driver', 20, [
            'created_at' => now()->subMonth(),
        ]);

        // Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ â€” Ûµ ØªØ§ (Ø²ÛŒØ± Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Û±Û°)
        $this->createMultipleSmsRecords('test_driver', 5);

        $this->handler->ensureUsable('test_driver', new NullDriver());

        $this->assertTrue(true);
    }

    // â”€â”€â”€ Scenario 5: Combined Limits â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_daily_and_monthly_limits_both_checked(): void
    {
        config(['sms.drivers.test_driver' => [
            'class'       => NullDriver::class,
            'credentials' => [],
            'usage'       => [
                'enabled'       => true,
                'daily_limit'   => 100,
                'monthly_limit' => 10,  // Ù…Ø§Ù‡Ø§Ù†Ù‡ Ú©Ù…ØªØ± Ø§Ø² Ø±ÙˆØ²Ø§Ù†Ù‡!
            ],
        ]]);

        // Û±Û° Ø±Ú©ÙˆØ±Ø¯ â†’ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ù¾Ø± Ø´Ø¯Ù‡ ÙˆÙ„ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ Ù†Ù‡
        $this->createMultipleSmsRecords('test_driver', 10);

        $this->expectException(DriverNotAvailableException::class);
        $this->expectExceptionMessage('monthly limit');

        $this->handler->ensureUsable('test_driver', new NullDriver());
    }

    public function test_disabled_checked_before_limits(): void
    {
        config(['sms.drivers.test_driver' => [
            'class'       => NullDriver::class,
            'credentials' => [],
            'usage'       => [
                'enabled'     => false,
                'daily_limit' => 1000, // Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¨Ø§Ù„Ø§ â€” Ø§Ù…Ø§ Ø¯Ø±Ø§ÛŒÙˆØ± ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª
            ],
        ]]);

        // Ø­ØªÛŒ Ø¨Ø¯ÙˆÙ† Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ÛŒØŒ Ø¯Ø±Ø§ÛŒÙˆØ± ØºÛŒØ±ÙØ¹Ø§Ù„ Ø¨Ø§ÛŒØ¯ Exception Ø¨Ø¯Ù‡Ø¯
        $this->expectException(DriverNotAvailableException::class);
        $this->expectExceptionMessage('disabled');

        $this->handler->ensureUsable('test_driver', new NullDriver());
    }

    // â”€â”€â”€ Scenario 6: Exception Message Quality â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_daily_limit_exception_includes_counts(): void
    {
        config(['sms.drivers.test_driver' => [
            'class'       => NullDriver::class,
            'credentials' => [],
            'usage'       => ['daily_limit' => 5],
        ]]);

        $this->createMultipleSmsRecords('test_driver', 7);

        try {
            $this->handler->ensureUsable('test_driver', new NullDriver());
            $this->fail('Expected DriverNotAvailableException');
        } catch (DriverNotAvailableException $e) {
            // Ù¾ÛŒØ§Ù… Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„ ØªØ¹Ø¯Ø§Ø¯ ÙØ¹Ù„ÛŒ Ùˆ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¨Ø§Ø´Ø¯
            $this->assertStringContainsString('7', $e->getMessage());  // ØªØ¹Ø¯Ø§Ø¯ ÙØ¹Ù„ÛŒ
            $this->assertStringContainsString('5', $e->getMessage());  // Ù…Ø­Ø¯ÙˆØ¯ÛŒØª
            $this->assertStringContainsString('test_driver', $e->getMessage());
        }
    }

    public function test_disabled_exception_includes_driver_name(): void
    {
        config(['sms.drivers.my_driver' => [
            'class'       => NullDriver::class,
            'credentials' => [],
            'usage'       => ['enabled' => false],
        ]]);

        try {
            $this->handler->ensureUsable('my_driver', new NullDriver());
            $this->fail('Expected DriverNotAvailableException');
        } catch (DriverNotAvailableException $e) {
            $this->assertStringContainsString('my_driver', $e->getMessage());
        }
    }

    // â”€â”€â”€ Interface â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_implements_interface(): void
    {
        $this->assertInstanceOf(SmsUsageHandler::class, new DefaultUsageHandler());
    }
}
```

---

## Û¶. `tests/Feature/UsageHandlerTest.php`

```php
<?php

namespace Karnoweb\SmsSender\Tests\Feature;

use Illuminate\Foundation\Testing\RefreshDatabase;
use Karnoweb\SmsSender\Contracts\SmsDriver;
use Karnoweb\SmsSender\Contracts\SmsUsageHandler;
use Karnoweb\SmsSender\Enums\SmsSendStatusEnum;
use Karnoweb\SmsSender\Exceptions\DriverNotAvailableException;
use Karnoweb\SmsSender\Facades\Sms;
use Karnoweb\SmsSender\Models\Sms as SmsModel;
use Karnoweb\SmsSender\SmsManager;
use Karnoweb\SmsSender\Support\DefaultUsageHandler;
use Karnoweb\SmsSender\Support\NullUsageHandler;
use Karnoweb\SmsSender\Tests\TestCase;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Ø¯Ø±Ø§ÛŒÙˆØ±Ù‡Ø§ÛŒ ØªØ³ØªÛŒ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * Ø¯Ø±Ø§ÛŒÙˆØ± ØªØ³ØªÛŒ Ú©Ù‡ Ø§Ø±Ø³Ø§Ù„â€ŒÙ‡Ø§ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
 */
class UsageRecordingDriver implements SmsDriver
{
    /** @var array<int, array{phone: string, message: string}> */
    public static array $sent = [];

    public function __construct(protected readonly array $config = []) {}

    public static function reset(): void
    {
        static::$sent = [];
    }

    public function send(string $phone, string $message): void
    {
        static::$sent[] = ['phone' => $phone, 'message' => $message];
    }
}

/**
 * UsageHandler Ø³ÙØ§Ø±Ø´ÛŒ Ú©Ù‡ Ù‡Ù…ÛŒØ´Ù‡ Exception Ù¾Ø±ØªØ§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
 * Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø§ÛŒÙ†Ú©Ù‡ Failover Ø¨Ø§ UsageHandler Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
 */
class AlwaysRejectHandler implements SmsUsageHandler
{
    public function ensureUsable(string $driverName, SmsDriver $driver): void
    {
        throw new DriverNotAvailableException(
            "Driver [{$driverName}] rejected by custom handler.",
        );
    }
}

/**
 * UsageHandler Ø³ÙØ§Ø±Ø´ÛŒ Ú©Ù‡ ÙÙ‚Ø· ÛŒÚ© Ø¯Ø±Ø§ÛŒÙˆØ± Ø®Ø§Øµ Ø±Ø§ Ø±Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
 */
class SelectiveRejectHandler implements SmsUsageHandler
{
    /** @var array<int, string> */
    public static array $rejectedDrivers = [];

    public function ensureUsable(string $driverName, SmsDriver $driver): void
    {
        if (in_array($driverName, static::$rejectedDrivers, true)) {
            throw new DriverNotAvailableException(
                "Driver [{$driverName}] is rejected.",
            );
        }
    }
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ØªØ³Øªâ€ŒÙ‡Ø§
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒÛŒ UsageHandler Ø¨Ø§ SmsManager.
 *
 * Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§:
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Û±. Ø¨Ø¯ÙˆÙ† UsageHandler â†’ NullUsageHandler (Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª)
 * Û². DefaultUsageHandler Ø§Ø² config â†’ Ú©Ù†ØªØ±Ù„ Ù…ØµØ±Ù
 * Û³. UsageHandler Ø³ÙØ§Ø±Ø´ÛŒ Ø§Ø² Container binding
 * Û´. Ø¯Ø±Ø§ÛŒÙˆØ± ØºÛŒØ±ÙØ¹Ø§Ù„ â†’ Failover Ø¨Ù‡ Ø¯Ø±Ø§ÛŒÙˆØ± Ø¨Ø¹Ø¯ÛŒ
 * Ûµ. Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡ â†’ Failover
 * Û¶. Ù‡Ù…Ù‡ Ø¯Ø±Ø§ÛŒÙˆØ±Ù‡Ø§ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ â†’ DriverNotAvailableException
 * Û·. UsageHandler Ø§Ø² config Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
 */
class UsageHandlerTest extends TestCase
{
    use RefreshDatabase;

    protected function defineDatabaseMigrations(): void
    {
        $this->loadMigrationsFrom(__DIR__ . '/../../database/migrations');
    }

    protected function setUp(): void
    {
        parent::setUp();

        UsageRecordingDriver::reset();
        SelectiveRejectHandler::$rejectedDrivers = [];
    }

    /**
     * SmsManager Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø³Ø§Ø²Ø¯ ØªØ§ UsageHandler Ø¬Ø¯ÛŒØ¯ Ø§Ø¹Ù…Ø§Ù„ Ø´ÙˆØ¯.
     *
     * Ú†ÙˆÙ† SmsManager singleton Ø§Ø³Øª Ùˆ UsageHandler Ø¯Ø± constructor Ø³Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ
     * Ø¨Ø¹Ø¯ Ø§Ø² ØªØºÛŒÛŒØ± config ÛŒØ§ binding Ø¨Ø§ÛŒØ¯ instance Ø¬Ø¯ÛŒØ¯ Ø³Ø§Ø®ØªÙ‡ Ø´ÙˆØ¯.
     */
    private function rebuildManager(): void
    {
        $this->app->forgetInstance(SmsManager::class);

        // Facade cache Ù‡Ù… Ø¨Ø§ÛŒØ¯ Ù¾Ø§Ú© Ø´ÙˆØ¯
        Sms::clearResolvedInstances();
    }

    // â”€â”€â”€ Scenario 1: Default â†’ NullUsageHandler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_default_handler_is_null_usage_handler(): void
    {
        // config Ù¾ÛŒØ´â€ŒÙØ±Ø¶: usage_handler = null
        $manager = $this->app->make(SmsManager::class);

        $reflection = new \ReflectionProperty(SmsManager::class, 'usageHandler');
        $handler    = $reflection->getValue($manager);

        $this->assertInstanceOf(NullUsageHandler::class, $handler);
    }

    public function test_null_handler_allows_sending(): void
    {
        config([
            'sms.default' => 'recording',
            'sms.drivers.recording' => [
                'class'       => UsageRecordingDriver::class,
                'credentials' => [],
            ],
        ]);

        $this->rebuildManager();

        Sms::message('ØªØ³Øª')->number('09120000000')->send();

        $this->assertCount(1, UsageRecordingDriver::$sent);
    }

    // â”€â”€â”€ Scenario 2: DefaultUsageHandler from config â”€â”€â”€â”€â”€â”€â”€

    public function test_default_usage_handler_from_config(): void
    {
        config([
            'sms.usage_handler' => DefaultUsageHandler::class,
        ]);

        $this->rebuildManager();

        $manager    = $this->app->make(SmsManager::class);
        $reflection = new \ReflectionProperty(SmsManager::class, 'usageHandler');
        $handler    = $reflection->getValue($manager);

        $this->assertInstanceOf(DefaultUsageHandler::class, $handler);
    }

    // â”€â”€â”€ Scenario 3: Custom handler from Container â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_custom_handler_from_container_binding(): void
    {
        // Bind Ú©Ø±Ø¯Ù† handler Ø³ÙØ§Ø±Ø´ÛŒ
        $this->app->bind(SmsUsageHandler::class, AlwaysRejectHandler::class);

        $this->rebuildManager();

        $manager    = $this->app->make(SmsManager::class);
        $reflection = new \ReflectionProperty(SmsManager::class, 'usageHandler');
        $handler    = $reflection->getValue($manager);

        $this->assertInstanceOf(AlwaysRejectHandler::class, $handler);
    }

    public function test_config_takes_priority_over_container(): void
    {
        // Ù‡Ù… config Ùˆ Ù‡Ù… container Ø³Øª Ø´Ø¯Ù‡
        config(['sms.usage_handler' => DefaultUsageHandler::class]);
        $this->app->bind(SmsUsageHandler::class, AlwaysRejectHandler::class);

        $this->rebuildManager();

        $manager    = $this->app->make(SmsManager::class);
        $reflection = new \ReflectionProperty(SmsManager::class, 'usageHandler');
        $handler    = $reflection->getValue($manager);

        // config Ø§ÙˆÙ„ÙˆÛŒØª Ø¯Ø§Ø±Ø¯
        $this->assertInstanceOf(DefaultUsageHandler::class, $handler);
    }

    // â”€â”€â”€ Scenario 4: Disabled driver â†’ Failover â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_disabled_driver_triggers_failover(): void
    {
        config([
            'sms.usage_handler' => DefaultUsageHandler::class,
            'sms.default'       => 'disabled_driver',
            'sms.failover'      => ['recording'],
            'sms.drivers.disabled_driver' => [
                'class'       => UsageRecordingDriver::class,
                'credentials' => [],
                'usage'       => [
                    'enabled' => false,
                ],
            ],
            'sms.drivers.recording' => [
                'class'       => UsageRecordingDriver::class,
                'credentials' => [],
                // Ø¨Ø¯ÙˆÙ† usage â†’ Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª
            ],
        ]);

        $this->rebuildManager();

        Sms::message('ØªØ³Øª failover')->number('09120000000')->send();

        // Ø¯Ø±Ø§ÛŒÙˆØ± Ø¯ÙˆÙ… Ø¨Ø§ÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        $this->assertCount(1, UsageRecordingDriver::$sent);

        // Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ø¯Ø±Ø§ÛŒÙˆØ± 'recording' Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        $this->assertDatabaseHas('sms_messages', [
            'driver' => 'recording',
            'status' => SmsSendStatusEnum::SENT->value,
        ]);

        // Ù†Ø¨Ø§ÛŒØ¯ Ø±Ú©ÙˆØ±Ø¯ÛŒ Ø¨Ø§ Ø¯Ø±Ø§ÛŒÙˆØ± disabled Ø¨Ø§Ø´Ø¯
        // (Ú†ÙˆÙ† UsageHandler Ù‚Ø¨Ù„ Ø§Ø² Ø³Ø§Ø®Øª Ø±Ú©ÙˆØ±Ø¯ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
        $this->assertDatabaseMissing('sms_messages', [
            'driver' => 'disabled_driver',
        ]);
    }

    // â”€â”€â”€ Scenario 5: Daily limit â†’ Failover â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_daily_limit_triggers_failover(): void
    {
        config([
            'sms.usage_handler' => DefaultUsageHandler::class,
            'sms.default'       => 'limited',
            'sms.failover'      => ['recording'],
            'sms.drivers.limited' => [
                'class'       => UsageRecordingDriver::class,
                'credentials' => [],
                'usage'       => [
                    'daily_limit' => 3,
                ],
            ],
            'sms.drivers.recording' => [
                'class'       => UsageRecordingDriver::class,
                'credentials' => [],
            ],
        ]);

        $this->rebuildManager();

        // Ø³Ø§Ø®Øª Û³ Ø±Ú©ÙˆØ±Ø¯ (Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª)
        for ($i = 0; $i < 3; $i++) {
            SmsModel::create([
                'driver'  => 'limited',
                'phone'   => '09120000000',
                'message' => "Test {$i}",
                'status'  => SmsSendStatusEnum::SENT,
            ]);
        }

        // Ø§Ø±Ø³Ø§Ù„ Ø¬Ø¯ÛŒØ¯ â†’ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø¯Ø±Ø§ÛŒÙˆØ± recording Ø¨Ø±ÙˆØ¯
        Sms::message('Ø¨Ø§ÛŒØ¯ Ø§Ø² recording Ø¨Ø±ÙˆØ¯')->number('09120000000')->send();

        $this->assertDatabaseHas('sms_messages', [
            'driver'  => 'recording',
            'message' => 'Ø¨Ø§ÛŒØ¯ Ø§Ø² recording Ø¨Ø±ÙˆØ¯',
        ]);
    }

    // â”€â”€â”€ Scenario 6: All drivers rejected â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_all_drivers_rejected_throws_exception(): void
    {
        // handler Ø³ÙØ§Ø±Ø´ÛŒ Ú©Ù‡ Ù‡Ù…Ù‡ Ø±Ø§ Ø±Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        $this->app->bind(SmsUsageHandler::class, AlwaysRejectHandler::class);

        config([
            'sms.usage_handler' => null, // Ø§Ø² Container binding Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
            'sms.default'       => 'driver_a',
            'sms.failover'      => ['driver_b'],
            'sms.drivers.driver_a' => [
                'class'       => UsageRecordingDriver::class,
                'credentials' => [],
            ],
            'sms.drivers.driver_b' => [
                'class'       => UsageRecordingDriver::class,
                'credentials' => [],
            ],
        ]);

        $this->rebuildManager();

        $this->expectException(DriverNotAvailableException::class);
        $this->expectExceptionMessage('No SMS drivers are available');

        Sms::message('ØªØ³Øª')->number('09120000000')->send();
    }

    public function test_rejection_exception_chains_last_error(): void
    {
        $this->app->bind(SmsUsageHandler::class, AlwaysRejectHandler::class);

        config([
            'sms.usage_handler' => null,
            'sms.default'       => 'test',
            'sms.drivers.test' => [
                'class'       => UsageRecordingDriver::class,
                'credentials' => [],
            ],
        ]);

        $this->rebuildManager();

        try {
            Sms::message('ØªØ³Øª')->number('09120000000')->send();
            $this->fail('Expected DriverNotAvailableException');
        } catch (DriverNotAvailableException $e) {
            // previous Ø¨Ø§ÛŒØ¯ Exception Ø§Ø² UsageHandler Ø¨Ø§Ø´Ø¯
            $this->assertInstanceOf(DriverNotAvailableException::class, $e->getPrevious());
            $this->assertStringContainsString('rejected', $e->getPrevious()->getMessage());
        }
    }

    // â”€â”€â”€ Scenario 7: Selective rejection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_selective_handler_rejects_specific_driver(): void
    {
        $this->app->singleton(SmsUsageHandler::class, SelectiveRejectHandler::class);

        // ÙÙ‚Ø· driver_a Ø±Ø§ Ø±Ø¯ Ú©Ù†
        SelectiveRejectHandler::$rejectedDrivers = ['driver_a'];

        config([
            'sms.usage_handler' => null,
            'sms.default'       => 'driver_a',
            'sms.failover'      => ['driver_b'],
            'sms.drivers.driver_a' => [
                'class'       => UsageRecordingDriver::class,
                'credentials' => [],
            ],
            'sms.drivers.driver_b' => [
                'class'       => UsageRecordingDriver::class,
                'credentials' => [],
            ],
        ]);

        $this->rebuildManager();

        Sms::message('ØªØ³Øª')->number('09120000000')->send();

        // Ø¨Ø§ÛŒØ¯ Ø§Ø² driver_b Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        $this->assertDatabaseHas('sms_messages', [
            'driver' => 'driver_b',
            'status' => SmsSendStatusEnum::SENT->value,
        ]);
    }

    // â”€â”€â”€ Scenario 8: State resets after usage rejection â”€â”€â”€â”€

    public function test_state_resets_after_all_rejected(): void
    {
        $this->app->bind(SmsUsageHandler::class, AlwaysRejectHandler::class);

        config([
            'sms.usage_handler' => null,
            'sms.default'       => 'test',
            'sms.drivers.test' => [
                'class'       => UsageRecordingDriver::class,
                'credentials' => [],
            ],
        ]);

        $this->rebuildManager();

        try {
            Sms::message('ØªØ³Øª')->number('09120000000')->send();
        } catch (DriverNotAvailableException) {
            // Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø§Ø±ÛŒÙ…
        }

        // state Ø¨Ø§ÛŒØ¯ Ù¾Ø§Ú© Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        $this->expectException(\Karnoweb\SmsSender\Exceptions\InvalidDriverConfigurationException::class);
        Sms::send();
    }

    // â”€â”€â”€ Scenario 9: Monthly limit integration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_monthly_limit_triggers_failover(): void
    {
        config([
            'sms.usage_handler' => DefaultUsageHandler::class,
            'sms.default'       => 'limited',
            'sms.failover'      => ['recording'],
            'sms.drivers.limited' => [
                'class'       => UsageRecordingDriver::class,
                'credentials' => [],
                'usage'       => [
                    'monthly_limit' => 5,
                ],
            ],
            'sms.drivers.recording' => [
                'class'       => UsageRecordingDriver::class,
                'credentials' => [],
            ],
        ]);

        $this->rebuildManager();

        // Ø³Ø§Ø®Øª Ûµ Ø±Ú©ÙˆØ±Ø¯ (Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù…Ø§Ù‡Ø§Ù†Ù‡)
        for ($i = 0; $i < 5; $i++) {
            SmsModel::create([
                'driver'  => 'limited',
                'phone'   => '09120000000',
                'message' => "Test {$i}",
                'status'  => SmsSendStatusEnum::SENT,
            ]);
        }

        Sms::message('Ù…Ø§Ù‡Ø§Ù†Ù‡ Ù¾Ø± Ø´Ø¯')->number('09120000000')->send();

        $this->assertDatabaseHas('sms_messages', [
            'driver'  => 'recording',
            'message' => 'Ù…Ø§Ù‡Ø§Ù†Ù‡ Ù¾Ø± Ø´Ø¯',
        ]);
    }

    // â”€â”€â”€ Scenario 10: No records â†’ passes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_handler_with_limits_passes_when_no_records(): void
    {
        config([
            'sms.usage_handler' => DefaultUsageHandler::class,
            'sms.default'       => 'recording',
            'sms.drivers.recording' => [
                'class'       => UsageRecordingDriver::class,
                'credentials' => [],
                'usage'       => [
                    'enabled'       => true,
                    'daily_limit'   => 100,
                    'monthly_limit' => 1000,
                ],
            ],
        ]);

        $this->rebuildManager();

        Sms::message('Ø§ÙˆÙ„ÛŒÙ† Ù¾ÛŒØ§Ù…Ú©')->number('09120000000')->send();

        $this->assertDatabaseCount('sms_messages', 1);
        $this->assertDatabaseHas('sms_messages', [
            'driver' => 'recording',
            'status' => SmsSendStatusEnum::SENT->value,
        ]);
    }
}
```

---

## âœ… Ú†Ú©â€ŒÙ„ÛŒØ³Øª ÙØ§Ø² Û¶

| Ø¢ÛŒØªÙ… | ÙˆØ¶Ø¹ÛŒØª |
|---|---|
| `DefaultUsageHandler` â€” Ø¨Ø±Ø±Ø³ÛŒ enabled/disabled | âœ… |
| `DefaultUsageHandler` â€” Ø¨Ø±Ø±Ø³ÛŒ daily_limit | âœ… |
| `DefaultUsageHandler` â€” Ø¨Ø±Ø±Ø³ÛŒ monthly_limit | âœ… |
| `DefaultUsageHandler` â€” Ø¨Ø¯ÙˆÙ† usage config â†’ Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª | âœ… |
| `DefaultUsageHandler` â€” Ø´Ù…Ø§Ø±Ø´ ÙÙ‚Ø· Ø¯Ø±Ø§ÛŒÙˆØ± Ù…Ø±Ø¨ÙˆØ·Ù‡ | âœ… |
| `DefaultUsageHandler` â€” Ø´Ù…Ø§Ø±Ø´ Ù‡Ù…Ù‡â€ŒÛŒ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ | âœ… |
| `DefaultUsageHandler` â€” Ø´Ù…Ø§Ø±Ø´ ÙÙ‚Ø· Ø¨Ø§Ø²Ù‡â€ŒÛŒ Ø²Ù…Ø§Ù†ÛŒ Ù…Ø±Ø¨ÙˆØ·Ù‡ | âœ… |
| `SmsManager` â€” catch `DriverNotAvailableException` Ø¯Ø± Failover | âœ… |
| `SmsManager` â€” resolveUsageHandler Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ (config â†’ container â†’ null) | âœ… |
| `config/sms.php` â€” Ø³Ø§Ø®ØªØ§Ø± usage per driver | âœ… |
| ØªØ³Øª NullUsageHandler â€” interface, never throws | âœ… |
| ØªØ³Øª DefaultUsageHandler â€” Û¶ Ø³Ù†Ø§Ø±ÛŒÙˆ + edge cases | âœ… |
| ØªØ³Øª Feature â€” Û±Û° Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ (failover, rejection, state) | âœ… |
| Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Exception Ø´Ø§Ù…Ù„ Ù†Ø§Ù… Ø¯Ø±Ø§ÛŒÙˆØ± Ùˆ ØªØ¹Ø¯Ø§Ø¯/Ù…Ø­Ø¯ÙˆØ¯ÛŒØª | âœ… |
| Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ø¬Ø§Ù…Ø¹ | âœ… |

---

**ÙØ§Ø² Û¶ Ú©Ø§Ù…Ù„ Ø´Ø¯.** Ø¨Ø±ÛŒÙ… ÙØ§Ø² Û· (ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø¬Ø§Ù…Ø¹)ØŸ