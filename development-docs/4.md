

# ÙØ§Ø² Û´ â€” Ù‡Ø³ØªÙ‡â€ŒÛŒ SmsManager

## Ø³Ø§Ø®ØªØ§Ø± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ùˆ ØªØºÛŒÛŒØ±â€ŒÛŒØ§ÙØªÙ‡

```
src/
â”œâ”€â”€ SmsManager.php                     â† Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ú©Ø§Ù…Ù„
â”œâ”€â”€ Support/
â”‚   â””â”€â”€ NullUsageHandler.php           â† Ø¬Ø¯ÛŒØ¯ (Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶)
â”œâ”€â”€ Drivers/
â”‚   â””â”€â”€ NullDriver.php                 â† Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±
config/
â””â”€â”€ sms.php                            â† Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ú©Ù„ÛŒØ¯ usage_handler
tests/
â”œâ”€â”€ Unit/
â”‚   â””â”€â”€ SmsManager/
â”‚       â”œâ”€â”€ BuilderTest.php
â”‚       â”œâ”€â”€ TemplateCompilerTest.php
â”‚       â”œâ”€â”€ DriverResolutionTest.php
â”‚       â””â”€â”€ ResetTest.php
â””â”€â”€ Feature/
    â”œâ”€â”€ SendTest.php
    â””â”€â”€ FailoverTest.php
```

---

## Û±. `src/SmsManager.php` (Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ú©Ø§Ù…Ù„)

```php
<?php

namespace Karnoweb\SmsSender;

use Illuminate\Contracts\Container\Container;
use Karnoweb\SmsSender\Contracts\SmsDriver;
use Karnoweb\SmsSender\Contracts\SmsUsageHandler;
use Karnoweb\SmsSender\Enums\SmsSendStatusEnum;
use Karnoweb\SmsSender\Enums\SmsTemplateEnum;
use Karnoweb\SmsSender\Exceptions\DriverConnectionException;
use Karnoweb\SmsSender\Exceptions\DriverNotAvailableException;
use Karnoweb\SmsSender\Exceptions\InvalidDriverConfigurationException;
use Karnoweb\SmsSender\Models\Sms;

/**
 * Ù…Ø¯ÛŒØ± Ø§ØµÙ„ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…Ú© â€” Builder / Facade Ø³Ø·Ø­ Ø¨Ø§Ù„Ø§.
 *
 * Ù…Ø³Ø¦ÙˆÙ„ÛŒØªâ€ŒÙ‡Ø§:
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Û±. Ø±Ø§Ø¨Ø· Fluent Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù…Ú© (Ù‚Ø§Ù„Ø¨ØŒ ÙˆØ±ÙˆØ¯ÛŒØŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡)
 * Û². Resolve Ú©Ø±Ø¯Ù† Ø¯Ø±Ø§ÛŒÙˆØ±Ù‡Ø§ Ø§Ø² Config Ùˆ Container
 * Û³. Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Failover Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨ÛŒÙ† Ø¯Ø±Ø§ÛŒÙˆØ±Ù‡Ø§
 * Û´. Ø«Ø¨Øª Ù„Ø§Ú¯ Ù‡Ø± Ù¾ÛŒØ§Ù…Ú© Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
 * Ûµ. Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª ØªØ­ÙˆÛŒÙ„ (ÙØ§Ø² Ûµ)
 *
 * Ù†Ù…ÙˆÙ†Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡:
 * ```php
 * // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø³Ø§Ø¯Ù‡
 * Sms::message('Ø³Ù„Ø§Ù… Ø¯Ù†ÛŒØ§')->number('09120000000')->send();
 *
 * // Ø§Ø±Ø³Ø§Ù„ OTP Ø¨Ø§ Ù‚Ø§Ù„Ø¨ Enum
 * Sms::otp(SmsTemplateEnum::LOGIN_OTP)
 *     ->input('code', '1234')
 *     ->number('09120000000')
 *     ->send();
 *
 * // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú†Ù†Ø¯ Ø´Ù…Ø§Ø±Ù‡
 * Sms::message('Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ')
 *     ->numbers(['09120000000', '09130000000'])
 *     ->send();
 * ```
 *
 * Ú†Ø±Ø®Ù‡â€ŒÛŒ Ø­ÛŒØ§Øª:
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * - Ø¨Ø¹Ø¯ Ø§Ø² Ù‡Ø± send() ÛŒØ§ checkStatus()ØŒ Ù…ØªØ¯ reset() ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
 * - Ø§ÛŒÙ† ØªØ¶Ù…ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Singleton instance Ø¢Ù„ÙˆØ¯Ù‡ Ù†Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯.
 * - Ù‡Ø± Ø²Ù†Ø¬ÛŒØ±Ù‡â€ŒÛŒ Fluent Ù…Ø³ØªÙ‚Ù„ Ø§Ø² Ù‚Ø¨Ù„ÛŒ Ø¹Ù…Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
 */
class SmsManager
{
    // â”€â”€â”€ Builder State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Ø§ÛŒÙ† ÙÛŒÙ„Ø¯Ù‡Ø§ Ø¯Ø± Ù‡Ø± Ø²Ù†Ø¬ÛŒØ±Ù‡â€ŒÛŒ Fluent Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ Ùˆ Ø¨Ø¹Ø¯ Ø§Ø² send() Ø±ÛŒØ³Øª Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.

    /** @var array<int, string> Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡ */
    protected array $toNumbers = [];

    /** @var string|null Ù…ØªÙ† Ø³Ø§Ø¯Ù‡â€ŒÛŒ Ù¾ÛŒØ§Ù… (Ø¨Ø¯ÙˆÙ† Ù‚Ø§Ù„Ø¨) */
    protected ?string $messageText = null;

    /** @var string|null Ù…ØªÙ† Ù‚Ø§Ù„Ø¨ (Ø§Ø² Enum ÛŒØ§ Ù…Ù†Ø¨Ø¹ Ø¯ÛŒÚ¯Ø±) */
    protected ?string $templateText = null;

    /** @var string|null Ù†Ø§Ù… Ù‚Ø§Ù„Ø¨ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ù„Ø§Ú¯ */
    protected ?string $templateName = null;

    /** @var array<string, string> ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ù„Ø¨ (placeholder => value) */
    protected array $inputs = [];

    /** @var SmsUsageHandler handler Ú©Ù†ØªØ±Ù„ Ù…ØµØ±Ù */
    protected SmsUsageHandler $usageHandler;

    /**
     * @param Container $container Ú©Ø§Ù†ØªÛŒÙ†Ø± Ù„Ø§Ø±Ø§ÙˆÙ„ Ø¨Ø±Ø§ÛŒ resolve Ø¯Ø±Ø§ÛŒÙˆØ±Ù‡Ø§
     */
    public function __construct(
        protected readonly Container $container,
    ) {
        // UsageHandler Ø§Ø² Container Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
        // Ø§Ú¯Ø± bind Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ NullUsageHandler Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø¬Ø§Ø²Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯).
        $this->usageHandler = $this->resolveUsageHandler();
    }

    /**
     * Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø±ÛŒØ¹ Ø¨Ù‡ instance Ø§Ø² Container.
     *
     * Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ§Ø±Ø¯ÛŒ Ú©Ù‡ DI ÛŒØ§ Facade Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.
     * Ø¯Ø± Ø´Ø±Ø§ÛŒØ· Ø¹Ø§Ø¯ÛŒ Ø§Ø² Facade (Sms::) ÛŒØ§ Constructor Injection Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.
     */
    public static function instance(): static
    {
        /** @var static $instance */
        $instance = app(static::class);

        return $instance;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  BUILDER â€” ØªÙ†Ø¸ÛŒÙ… Ù¾ÛŒØ§Ù…
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ØªÙ†Ø¸ÛŒÙ… Ù…ØªÙ† Ø³Ø§Ø¯Ù‡â€ŒÛŒ Ù¾ÛŒØ§Ù….
     *
     * ÙˆÙ‚ØªÛŒ Ø§Ø² message() Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯ØŒ Ù‚Ø§Ù„Ø¨ Ùˆ inputs Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
     * ÛŒØ¹Ù†ÛŒ message() Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§Ù„Ø§ØªØ±ÛŒ Ø§Ø² otp() Ø¯Ø§Ø±Ø¯.
     *
     * @param string $message Ù…ØªÙ† Ù†Ù‡Ø§ÛŒÛŒ Ù¾ÛŒØ§Ù…Ú©
     * @return $this Ø¨Ø±Ø§ÛŒ Ø²Ù†Ø¬ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ (Fluent)
     */
    public function message(string $message): static
    {
        $this->messageText = $message;

        return $this;
    }

    /**
     * ØªÙ†Ø¸ÛŒÙ… Ù‚Ø§Ù„Ø¨ OTP/Ø³ÛŒØ³ØªÙ…ÛŒ Ø§Ø² Enum.
     *
     * Ù…ØªÙ† Ù‚Ø§Ù„Ø¨ Ø§Ø² value Enum Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ placeholder Ù‡Ø§
     * Ø¨Ø§ Ù…ØªØ¯ input()/inputs() Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
     *
     * @param SmsTemplateEnum $template Ù‚Ø§Ù„Ø¨ Enum
     * @return $this
     */
    public function otp(SmsTemplateEnum $template): static
    {
        $this->templateText = $template->value;
        $this->templateName = $template->name;

        return $this;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  BUILDER â€” ØªÙ†Ø¸ÛŒÙ… Inputs
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Ø§ÙØ²ÙˆØ¯Ù† ÛŒÚ© ÙˆØ±ÙˆØ¯ÛŒ Ø¨Ù‡ Ù‚Ø§Ù„Ø¨.
     *
     * Ù…Ø«Ø§Ù„: ->input('code', '1234') Ø¨Ø§Ø¹Ø« Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ {code} Ø¨Ø§ 1234 Ù…ÛŒâ€ŒØ´ÙˆØ¯.
     *
     * @param string $key   Ù†Ø§Ù… placeholder (Ø¨Ø¯ÙˆÙ† {})
     * @param string $value Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†
     * @return $this
     */
    public function input(string $key, string $value): static
    {
        $this->inputs[$key] = $value;

        return $this;
    }

    /**
     * Ø§ÙØ²ÙˆØ¯Ù† Ú†Ù†Ø¯ÛŒÙ† ÙˆØ±ÙˆØ¯ÛŒ Ø¨Ù‡ Ù‚Ø§Ù„Ø¨.
     *
     * Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù‚Ø¨Ù„ÛŒ merge Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ (Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¬Ø¯ÛŒØ¯ Ø§ÙˆÙ„ÙˆÛŒØª Ø¯Ø§Ø±Ù†Ø¯).
     *
     * @param array<string, string> $inputs Ø¢Ø±Ø§ÛŒÙ‡â€ŒÛŒ key => value
     * @return $this
     */
    public function inputs(array $inputs): static
    {
        $this->inputs = array_merge($this->inputs, $inputs);

        return $this;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  BUILDER â€” ØªÙ†Ø¸ÛŒÙ… Ú¯ÛŒØ±Ù†Ø¯Ù‡â€ŒÙ‡Ø§
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Ø§ÙØ²ÙˆØ¯Ù† ÛŒÚ© Ø´Ù…Ø§Ø±Ù‡â€ŒÛŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡.
     *
     * @param string $phone Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ (Ù…Ø«Ù„Ø§Ù‹ '09120000000')
     * @return $this
     */
    public function number(string $phone): static
    {
        $this->toNumbers[] = $phone;

        return $this;
    }

    /**
     * Ø§ÙØ²ÙˆØ¯Ù† Ú†Ù†Ø¯ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡â€ŒÛŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡.
     *
     * ØªÙ…Ø§Ù… Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¨Ù‡ string ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ (Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ù†ÙˆØ¹ Ø¯Ø§Ø¯Ù‡).
     *
     * @param array<int, string|int> $phones Ø¢Ø±Ø§ÛŒÙ‡â€ŒÛŒ Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§
     * @return $this
     */
    public function numbers(array $phones): static
    {
        foreach ($phones as $phone) {
            $this->toNumbers[] = (string) $phone;
        }

        return $this;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SEND â€” Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…Ú©
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…Ú© Ø¨Ù‡ ØªÙ…Ø§Ù… Ú¯ÛŒØ±Ù†Ø¯Ù‡â€ŒÙ‡Ø§.
     *
     * Ù…Ø±Ø§Ø­Ù„:
     * â”€â”€â”€â”€â”€â”€
     * Û±. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒØ³Øª ÛŒÚ©ØªØ§ÛŒ Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ (resolveTargets)
     * Û². Ø³Ø§Ø®Øª Ù…ØªÙ† Ù†Ù‡Ø§ÛŒÛŒ Ù¾ÛŒØ§Ù… (resolveMessage)
     * Û³. Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù‡Ù…Ù‡â€ŒÛŒ Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…Ú©Ø§Ù†ÛŒØ²Ù… Failover (sendToTargets)
     * Û´. Ø±ÛŒØ³Øª state Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡â€ŒÛŒ Ù…Ø¬Ø¯Ø¯
     *
     * @throws InvalidDriverConfigurationException Ø§Ú¯Ø± Ú¯ÛŒØ±Ù†Ø¯Ù‡ ÛŒØ§ Ù¾ÛŒØ§Ù…ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
     * @throws DriverNotAvailableException Ø§Ú¯Ø± Ù‡ÛŒÚ† Ø¯Ø±Ø§ÛŒÙˆØ±ÛŒ Ù…ÙˆÙÙ‚ Ù†Ø´ÙˆØ¯
     */
    public function send(): void
    {
        try {
            // â”€â”€ Ù…Ø±Ø­Ù„Ù‡ Û±: Ú¯ÛŒØ±Ù†Ø¯Ù‡â€ŒÙ‡Ø§ â”€â”€
            $targets = $this->resolveTargets();

            if (empty($targets)) {
                throw new InvalidDriverConfigurationException(
                    'No recipients provided.',
                );
            }

            // â”€â”€ Ù…Ø±Ø­Ù„Ù‡ Û²: Ù…ØªÙ† Ù¾ÛŒØ§Ù… â”€â”€
            $message = $this->resolveMessage();

            if ($message === null) {
                throw new InvalidDriverConfigurationException(
                    'No message or template provided.',
                );
            }

            // â”€â”€ Ù…Ø±Ø­Ù„Ù‡ Û³: Ø§Ø±Ø³Ø§Ù„ â”€â”€
            $this->sendToTargets($targets, $message);
        } finally {
            // â”€â”€ Ù…Ø±Ø­Ù„Ù‡ Û´: Ø±ÛŒØ³Øª â”€â”€
            // Ø­ØªÙ…Ø§Ù‹ Ø¨Ø§ÛŒØ¯ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯ØŒ Ø­ØªÛŒ Ø§Ú¯Ø± Exception Ù¾Ø±ØªØ§Ø¨ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯.
            // Ø§Ú¯Ø± Ø±ÛŒØ³Øª Ù†Ø´ÙˆØ¯ØŒ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø¨Ø¹Ø¯ÛŒ Ø¨Ø§ state Ø¢Ù„ÙˆØ¯Ù‡ Ù…ÙˆØ§Ø¬Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
            $this->reset();
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  RESOLVE â€” ØªØ¨Ø¯ÛŒÙ„ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Builder Ø¨Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒØ³Øª ÛŒÚ©ØªØ§ÛŒ Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡.
     *
     * Ù…Ø±Ø§Ø­Ù„:
     * - Ø´Ø±ÙˆØ¹ Ø§Ø² toNumbers
     * - Ø­Ø°Ù ØªÚ©Ø±Ø§Ø±ÛŒâ€ŒÙ‡Ø§ Ø¨Ø§ array_unique
     * - Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ index Ù‡Ø§ Ø¨Ø§ array_values
     *
     * @return array<int, string>
     */
    protected function resolveTargets(): array
    {
        return array_values(array_unique($this->toNumbers));
    }

    /**
     * Ø³Ø§Ø®Øª Ù…ØªÙ† Ù†Ù‡Ø§ÛŒÛŒ Ù¾ÛŒØ§Ù…Ú©.
     *
     * Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ:
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * Û±. Ø§Ú¯Ø± messageText Ø³Øª Ø´Ø¯Ù‡ â†’ Ù‡Ù…Ø§Ù† Ù…ØªÙ† Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
     * Û². Ø§Ú¯Ø± templateText Ø³Øª Ø´Ø¯Ù‡ â†’ Ø¨Ø§ compileTemplate Ùˆ inputs Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…ÛŒâ€ŒØ´ÙˆØ¯
     * Û³. Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª â†’ null (Ùˆ Ø¨Ø¹Ø¯Ø§Ù‹ Exception Ù¾Ø±ØªØ§Ø¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
     *
     * Ø§ÛŒÙ† Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø§Ø¹Ø« Ù…ÛŒâ€ŒØ´ÙˆØ¯:
     * - message('Ø³Ù„Ø§Ù…') Ù‡Ù…ÛŒØ´Ù‡ Ø¨Ø± otp() ØºÙ„Ø¨Ù‡ Ú©Ù†Ø¯
     * - Ø§Ú¯Ø± Ù‡ÛŒÚ†â€ŒÚ©Ø¯Ø§Ù… Ø³Øª Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø®Ø·Ø§ Ù…Ø´Ø®Øµ Ø¨Ø§Ø´Ø¯
     */
    protected function resolveMessage(): ?string
    {
        // Ø§ÙˆÙ„ÙˆÛŒØª Û±: Ù…ØªÙ† Ø³Ø§Ø¯Ù‡
        if ($this->messageText !== null) {
            return $this->messageText;
        }

        // Ø§ÙˆÙ„ÙˆÛŒØª Û²: Ù‚Ø§Ù„Ø¨ + inputs
        if ($this->templateText !== null) {
            return $this->compileTemplate($this->templateText, $this->inputs);
        }

        // Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù…ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡
        return null;
    }

    /**
     * Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ placeholder Ù‡Ø§ Ø¯Ø± Ù‚Ø§Ù„Ø¨ Ø¨Ø§ Ù…Ù‚Ø§Ø¯ÛŒØ± ÙˆØ§Ù‚Ø¹ÛŒ.
     *
     * Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ…:
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * - Ù‡Ø± ÙˆØ±ÙˆØ¯ÛŒ Ø¨Ø§ Ú©Ù„ÛŒØ¯ `key` Ø¨Ù‡ placeholder `{key}` ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
     * - Ø³Ù¾Ø³ str_replace Ø±ÙˆÛŒ Ú©Ù„ Ù‚Ø§Ù„Ø¨ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯
     * - Ø§Ú¯Ø± inputs Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯ØŒ Ù‚Ø§Ù„Ø¨ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
     *
     * Ù…Ø«Ø§Ù„:
     *   compileTemplate('Ú©Ø¯: {code}', ['code' => '1234']) â†’ 'Ú©Ø¯: 1234'
     *
     * @param string                $template Ù…ØªÙ† Ù‚Ø§Ù„Ø¨ Ø¨Ø§ placeholder Ù‡Ø§
     * @param array<string, string> $inputs   Ø¢Ø±Ø§ÛŒÙ‡â€ŒÛŒ key => value
     * @return string Ù…ØªÙ† Ù†Ù‡Ø§ÛŒÛŒ
     */
    protected function compileTemplate(string $template, array $inputs = []): string
    {
        if (empty($inputs)) {
            return $template;
        }

        $search  = [];
        $replace = [];

        foreach ($inputs as $key => $value) {
            $search[]  = '{' . $key . '}';
            $replace[] = (string) $value;
        }

        return str_replace($search, $replace, $template);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  DRIVER â€” Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø±Ø§ÛŒÙˆØ±Ù‡Ø§
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ØªØ±ØªÛŒØ¨ Ø¯Ø±Ø§ÛŒÙˆØ±Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ (default + failover).
     *
     * Ù…Ù†Ø·Ù‚:
     * â”€â”€â”€â”€â”€â”€
     * Û±. Ø§Ø¨ØªØ¯Ø§ Ø¯Ø±Ø§ÛŒÙˆØ± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ (config: sms.default)
     * Û². Ø³Ù¾Ø³ Ø¯Ø±Ø§ÛŒÙˆØ±Ù‡Ø§ÛŒ failover Ø¨Ù‡ ØªØ±ØªÛŒØ¨ (config: sms.failover)
     * Û³. Ø­Ø°Ù ØªÚ©Ø±Ø§Ø±ÛŒâ€ŒÙ‡Ø§ (Ø§Ú¯Ø± default Ø¯Ø± failover Ù‡Ù… Ø¨Ø§Ø´Ø¯)
     * Û´. Ø§Ú¯Ø± Ù†ØªÛŒØ¬Ù‡ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯ â†’ Exception
     *
     * Ù…Ø«Ø§Ù„:
     *   default: 'kavenegar'
     *   failover: ['melipayamak', 'farazsms']
     *   Ù†ØªÛŒØ¬Ù‡: ['kavenegar', 'melipayamak', 'farazsms']
     *
     * @return array<int, string> Ù„ÛŒØ³Øª Ù…Ø±ØªØ¨ Ù†Ø§Ù… Ø¯Ø±Ø§ÛŒÙˆØ±Ù‡Ø§
     * @throws InvalidDriverConfigurationException Ø§Ú¯Ø± Ù‡ÛŒÚ† Ø¯Ø±Ø§ÛŒÙˆØ±ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
     */
    protected function getDriverOrder(): array
    {
        $default  = config('sms.default');
        $failover = config('sms.failover', []);

        // Ø³Ø§Ø®Øª Ù„ÛŒØ³Øª: default Ø§ÙˆÙ„ØŒ Ø¨Ø¹Ø¯ failover Ù‡Ø§
        $order = [];

        if (! empty($default)) {
            $order[] = $default;
        }

        if (is_array($failover)) {
            $order = array_merge($order, $failover);
        }

        // Ø­Ø°Ù ØªÚ©Ø±Ø§Ø±ÛŒâ€ŒÙ‡Ø§ (Ø­ÙØ¸ ØªØ±ØªÛŒØ¨)
        $order = array_values(array_unique($order));

        if (empty($order)) {
            throw new InvalidDriverConfigurationException(
                'No SMS driver configured. Set SMS_DRIVER in .env or update config/sms.php.',
            );
        }

        return $order;
    }

    /**
     * Ø³Ø§Ø®Øª Ù†Ù…ÙˆÙ†Ù‡â€ŒÛŒ Ø¯Ø±Ø§ÛŒÙˆØ± Ø§Ø² Container Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù….
     *
     * Ù…Ø±Ø§Ø­Ù„:
     * â”€â”€â”€â”€â”€â”€
     * Û±. Ø®ÙˆØ§Ù†Ø¯Ù† config Ø§Ø² sms.drivers.{name}
     * Û². Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ú©Ù„ÛŒØ¯ 'class' Ùˆ Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† Ø¢Ù†
     * Û³. Ø³Ø§Ø®Øª Ø¯Ø±Ø§ÛŒÙˆØ± Ø¨Ø§ Container (ØªØ²Ø±ÛŒÙ‚ config Ø¨Ù‡ Ø³Ø§Ø²Ù†Ø¯Ù‡)
     * Û´. Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¯Ø±Ø§ÛŒÙˆØ± Ø§ÛŒÙ†ØªØ±ÙÛŒØ³ SmsDriver Ø±Ø§ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø±Ø¯Ù‡
     *
     * Ú†Ø±Ø§ Ø§Ø² Container Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…ØŸ
     * - ØªØ§ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø§ÛŒÙˆØ± (Ù…Ø«Ù„Ø§Ù‹ HttpClient) Ù‡Ù… resolve Ø´ÙˆÙ†Ø¯
     * - ØªØ§ ØªØ³Øªâ€ŒÙ¾Ø°ÛŒØ±ÛŒ Ø¨Ù‡ØªØ± Ø¨Ø§Ø´Ø¯ (Ù‚Ø§Ø¨Ù„ mock/bind)
     *
     * @param string $name Ù†Ø§Ù… Ø¯Ø±Ø§ÛŒÙˆØ± (Ú©Ù„ÛŒØ¯ Ø¯Ø± config)
     * @return SmsDriver Ù†Ù…ÙˆÙ†Ù‡â€ŒÛŒ Ø¢Ù…Ø§Ø¯Ù‡â€ŒÛŒ Ø¯Ø±Ø§ÛŒÙˆØ±
     * @throws InvalidDriverConfigurationException Ø§Ú¯Ø± config Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø´Ø¯
     */
    protected function resolveDriver(string $name): SmsDriver
    {
        $driverConfig = config("sms.drivers.{$name}");

        // â”€â”€ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ØªÙ†Ø¸ÛŒÙ…Ø§Øª â”€â”€
        if (! is_array($driverConfig) || empty($driverConfig)) {
            throw new InvalidDriverConfigurationException(
                "SMS driver [{$name}] is not defined in config/sms.php.",
            );
        }

        $class = $driverConfig['class'] ?? null;

        // â”€â”€ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ú©Ù„Ø§Ø³ â”€â”€
        if (empty($class) || ! is_string($class)) {
            throw new InvalidDriverConfigurationException(
                "Driver class for [{$name}] is not specified in config/sms.php.",
            );
        }

        if (! class_exists($class)) {
            throw new InvalidDriverConfigurationException(
                "Driver class [{$class}] for [{$name}] does not exist.",
            );
        }

        // â”€â”€ Ø³Ø§Ø®Øª Ø¯Ø±Ø§ÛŒÙˆØ± â”€â”€
        // credentials Ø§Ø² config Ø®ÙˆØ§Ù†Ø¯Ù‡ Ùˆ Ø¨Ù‡ Ø³Ø§Ø²Ù†Ø¯Ù‡â€ŒÛŒ Ø¯Ø±Ø§ÛŒÙˆØ± Ù¾Ø§Ø³ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        $credentials = $driverConfig['credentials'] ?? [];

        /** @var SmsDriver $driver */
        $driver = $this->container->make($class, [
            'config' => $credentials,
        ]);

        // â”€â”€ Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†ØªØ±ÙÛŒØ³ â”€â”€
        if (! $driver instanceof SmsDriver) {
            throw new InvalidDriverConfigurationException(
                "Driver [{$class}] must implement " . SmsDriver::class . '.',
            );
        }

        return $driver;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SEND TO TARGETS â€” Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Failover
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…Ú© Ø¨Ù‡ Ù„ÛŒØ³Øª Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…Ú©Ø§Ù†ÛŒØ²Ù… Failover.
     *
     * Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Failover:
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * Û±. Ù„ÛŒØ³Øª Ø¯Ø±Ø§ÛŒÙˆØ±Ù‡Ø§ Ø±Ø§ Ø¨Ú¯ÛŒØ± (default + failover)
     * Û². Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ø±Ø§ÛŒÙˆØ±:
     *    a. Ø¯Ø±Ø§ÛŒÙˆØ± Ø±Ø§ resolve Ú©Ù†
     *    b. Ø¨Ø±Ø±Ø³ÛŒ usable Ø¨ÙˆØ¯Ù† (UsageHandler)
     *    c. Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø´Ù…Ø§Ø±Ù‡:
     *       - Ø±Ú©ÙˆØ±Ø¯ PENDING Ø¨Ø³Ø§Ø²
     *       - Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Ø¯Ø±Ø§ÛŒÙˆØ±
     *       - Ø¯Ø± ØµÙˆØ±Øª Ù…ÙˆÙÙ‚ÛŒØª: ÙˆØ¶Ø¹ÛŒØª â†’ SENT
     *    d. Ø§Ú¯Ø± Ù‡Ù…Ù‡ Ù…ÙˆÙÙ‚ Ø´Ø¯ â†’ return (ØªÙ…Ø§Ù…)
     * Û³. Ø§Ú¯Ø± Ø®Ø·Ø§ÛŒ InvalidDriverConfiguration ÛŒØ§ DriverConnection Ø±Ø® Ø¯Ø§Ø¯:
     *    - Ø§ÛŒÙ† Ø¯Ø±Ø§ÛŒÙˆØ± Ø±Ø§ Ø±Ø¯ Ú©Ù† (skip)
     *    - Ø¯Ø±Ø§ÛŒÙˆØ± Ø¨Ø¹Ø¯ÛŒ Ø±Ø§ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†
     * Û´. Ø§Ú¯Ø± Ø®Ø·Ø§ÛŒ Ø¯ÛŒÚ¯Ø±ÛŒ Ø±Ø® Ø¯Ø§Ø¯ (Ù…Ø«Ù„Ø§Ù‹ bug):
     *    - Ø¨Ø¯ÙˆÙ† catch Ø¨Ù‡ Ø¨Ø§Ù„Ø§ bubble Ú©Ù†Ø¯ (Failover ÙØ¹Ø§Ù„ Ù†Ø´ÙˆØ¯)
     * Ûµ. Ø§Ú¯Ø± Ù‡ÛŒÚ† Ø¯Ø±Ø§ÛŒÙˆØ±ÛŒ Ù…ÙˆÙÙ‚ Ù†Ø´Ø¯:
     *    - DriverNotAvailableException Ù¾Ø±ØªØ§Ø¨ Ø´ÙˆØ¯
     *
     * Ú†Ø±Ø§ ÙÙ‚Ø· Ø¯Ùˆ Ù†ÙˆØ¹ Exception Ø¨Ø§Ø¹Ø« Failover Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ØŸ
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * - InvalidDriverConfigurationException: Ù…Ø´Ú©Ù„ config (Ù‚Ø§Ø¨Ù„ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ)
     * - DriverConnectionException: Ù…Ø´Ú©Ù„ Ø§Ø±ØªØ¨Ø§Ø·ÛŒ (Ù‚Ø§Ø¨Ù„ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ)
     * - Ø³Ø§ÛŒØ± Exception Ù‡Ø§: Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ bug Ù‡Ø³ØªÙ†Ø¯ Ùˆ Ø¨Ø§ÛŒØ¯ Ø³Ø±ÛŒØ¹ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´ÙˆÙ†Ø¯
     *
     * @param array<int, string> $phoneNumbers Ù„ÛŒØ³Øª Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§
     * @param string             $message      Ù…ØªÙ† Ù†Ù‡Ø§ÛŒÛŒ Ù¾ÛŒØ§Ù…Ú©
     * @throws DriverNotAvailableException Ø§Ú¯Ø± Ù‡ÛŒÚ† Ø¯Ø±Ø§ÛŒÙˆØ±ÛŒ Ù…ÙˆÙÙ‚ Ù†Ø´ÙˆØ¯
     */
    protected function sendToTargets(array $phoneNumbers, string $message): void
    {
        $driverOrder   = $this->getDriverOrder();
        $lastException = null;

        foreach ($driverOrder as $driverName) {
            try {
                // â”€â”€ Resolve Ø¯Ø±Ø§ÛŒÙˆØ± â”€â”€
                $driver = $this->resolveDriver($driverName);

                // â”€â”€ Ø¨Ø±Ø±Ø³ÛŒ Ù…ØµØ±Ù/ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù† â”€â”€
                $this->usageHandler->ensureUsable($driverName, $driver);

                // â”€â”€ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù‡Ù…Ù‡â€ŒÛŒ Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ â”€â”€
                $this->sendWithDriver($driverName, $driver, $phoneNumbers, $message);

                // âœ… Ù‡Ù…Ù‡â€ŒÛŒ Ø§Ø±Ø³Ø§Ù„â€ŒÙ‡Ø§ Ù…ÙˆÙÙ‚ Ø´Ø¯ â€” Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ù„Ù‚Ù‡â€ŒÛŒ Failover
                return;

            } catch (InvalidDriverConfigurationException $e) {
                // âš ï¸ Ù…Ø´Ú©Ù„ config â€” Ø¯Ø±Ø§ÛŒÙˆØ± Ø¨Ø¹Ø¯ÛŒ Ø±Ø§ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†
                $lastException = $e;
                continue;

            } catch (DriverConnectionException $e) {
                // âš ï¸ Ù…Ø´Ú©Ù„ Ø§Ø±ØªØ¨Ø§Ø·ÛŒ â€” Ø¯Ø±Ø§ÛŒÙˆØ± Ø¨Ø¹Ø¯ÛŒ Ø±Ø§ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†
                $lastException = $e;
                continue;
            }

            // ğŸ”´ Ø³Ø§ÛŒØ± Exception Ù‡Ø§ (bug): Ø¨Ù‡ Ø¨Ø§Ù„Ø§ bubble Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯
            // Ø§ÛŒÙ† Ø±ÙØªØ§Ø± Ø¹Ù…Ø¯ÛŒ Ø§Ø³Øª â€” Failover ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„â€ŒÙ¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ
        }

        // âŒ Ù‡ÛŒÚ† Ø¯Ø±Ø§ÛŒÙˆØ±ÛŒ Ù…ÙˆÙÙ‚ Ù†Ø´Ø¯
        throw new DriverNotAvailableException(
            message:  'No SMS drivers are available to send messages.',
            previous: $lastException,
        );
    }

    /**
     * Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…Ú© Ø¨Ø§ ÛŒÚ© Ø¯Ø±Ø§ÛŒÙˆØ± Ù…Ø´Ø®Øµ Ø¨Ù‡ Ù„ÛŒØ³Øª Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§.
     *
     * Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø´Ù…Ø§Ø±Ù‡:
     * Û±. Ø±Ú©ÙˆØ±Ø¯ PENDING Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„)
     * Û². Ø¯Ø±Ø§ÛŒÙˆØ± ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯
     * Û³. Ø¯Ø± ØµÙˆØ±Øª Ù…ÙˆÙÙ‚ÛŒØª: ÙˆØ¶Ø¹ÛŒØª â†’ SENT
     * Û´. Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§: ÙˆØ¶Ø¹ÛŒØª â†’ FAILED Ùˆ Exception Ø¨Ù‡ Ø¨Ø§Ù„Ø§ Ù¾Ø±ØªØ§Ø¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯
     *
     * Ú†Ø±Ø§ Ø±Ú©ÙˆØ±Ø¯ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŸ
     * - ØªØ§ Ø­ØªÛŒ Ø§Ú¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø´Ú©Ø³Øª Ø¨Ø®ÙˆØ±Ø¯ØŒ Ù„Ø§Ú¯ Ø¢Ù† Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
     * - Ø¨Ø±Ø§ÛŒ Ø±Ø¯ÛŒØ§Ø¨ÛŒ Ùˆ debug Ù…Ø´Ú©Ù„Ø§Øª
     *
     * @param string              $driverName   Ù†Ø§Ù… Ø¯Ø±Ø§ÛŒÙˆØ± (Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯)
     * @param SmsDriver           $driver       Ù†Ù…ÙˆÙ†Ù‡â€ŒÛŒ Ø¯Ø±Ø§ÛŒÙˆØ±
     * @param array<int, string>  $phoneNumbers Ù„ÛŒØ³Øª Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§
     * @param string              $message      Ù…ØªÙ† Ù†Ù‡Ø§ÛŒÛŒ
     * @throws DriverConnectionException Ø§Ú¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø´Ú©Ø³Øª Ø¨Ø®ÙˆØ±Ø¯
     */
    protected function sendWithDriver(
        string $driverName,
        SmsDriver $driver,
        array $phoneNumbers,
        string $message,
    ): void {
        /** @var class-string<Sms> $modelClass */
        $modelClass = config('sms.model', Sms::class);

        foreach ($phoneNumbers as $phoneNumber) {
            // â”€â”€ Ø³Ø§Ø®Øª Ø±Ú©ÙˆØ±Ø¯ PENDING â”€â”€
            /** @var Sms $record */
            $record = $modelClass::create([
                'driver'   => $driverName,
                'template' => $this->templateName,
                'inputs'   => ! empty($this->inputs) ? $this->inputs : null,
                'phone'    => $phoneNumber,
                'message'  => $message,
                'status'   => SmsSendStatusEnum::PENDING,
            ]);

            try {
                // â”€â”€ Ø§Ø±Ø³Ø§Ù„ â”€â”€
                $driver->send($phoneNumber, $message);

                // â”€â”€ Ù…ÙˆÙÙ‚ÛŒØª â”€â”€
                $record->markAsSent();

            } catch (DriverConnectionException $e) {
                // â”€â”€ Ø´Ú©Ø³Øª â”€â”€
                // Ø±Ú©ÙˆØ±Ø¯ Ø±Ø§ FAILED Ú©Ù† Ùˆ Exception Ø±Ø§ re-throw Ú©Ù†
                // ØªØ§ Failover Ø¯Ø± sendToTargets ÙØ¹Ø§Ù„ Ø´ÙˆØ¯
                $record->markAsFailed($e->getMessage());

                throw $e;
            }
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  USAGE HANDLER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Resolve Ú©Ø±Ø¯Ù† UsageHandler Ø§Ø² Container.
     *
     * Ø§Ú¯Ø± Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† ÛŒÚ© UsageHandler Ø³ÙØ§Ø±Ø´ÛŒ bind Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø² Ø¢Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
     * Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª NullUsageHandler Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø¬Ø§Ø²Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯).
     */
    protected function resolveUsageHandler(): SmsUsageHandler
    {
        if ($this->container->bound(SmsUsageHandler::class)) {
            return $this->container->make(SmsUsageHandler::class);
        }

        return new \Karnoweb\SmsSender\Support\NullUsageHandler();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  RESET â€” Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† State
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Ø±ÛŒØ³Øª ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Builder.
     *
     * Ø§ÛŒÙ† Ù…ØªØ¯ Ø¨Ø¹Ø¯ Ø§Ø² Ù‡Ø± send() Ùˆ checkStatus() ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯ ØªØ§:
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * - State Ù‚Ø¨Ù„ÛŒ Ø±ÙˆÛŒ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø¨Ø¹Ø¯ÛŒ ØªØ£Ø«ÛŒØ± Ù†Ú¯Ø°Ø§Ø±Ø¯
     * - Instance Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡â€ŒÛŒ Ù…Ø¬Ø¯Ø¯ Ø¨Ø§Ø´Ø¯ (Ù…Ù‡Ù… Ø¨Ø±Ø§ÛŒ Singleton)
     *
     * Ù†Ú©ØªÙ‡: Ø§Ú¯Ø± reset ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù†Ø´ÙˆØ¯ Ùˆ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¯Ùˆ Ø¨Ø§Ø± Ù¾Ø´Øª Ø³Ø± Ù‡Ù… send() Ø¨Ø²Ù†Ø¯:
     *   Sms::message('Ø§ÙˆÙ„')->number('09121111111')->send();
     *   Sms::message('Ø¯ÙˆÙ…')->send(); // â† Ø¨Ø¯ÙˆÙ† resetØŒ Ø´Ù…Ø§Ø±Ù‡â€ŒÛŒ Ù‚Ø¨Ù„ÛŒ Ù‡Ù†ÙˆØ² Ù‡Ø³Øª!
     */
    protected function reset(): void
    {
        $this->toNumbers    = [];
        $this->messageText  = null;
        $this->templateText = null;
        $this->templateName = null;
        $this->inputs       = [];
    }
}
```

---

## Û². `src/Support/NullUsageHandler.php`

```php
<?php

namespace Karnoweb\SmsSender\Support;

use Karnoweb\SmsSender\Contracts\SmsDriver;
use Karnoweb\SmsSender\Contracts\SmsUsageHandler;

/**
 * Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ UsageHandler â€” Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø¬Ø§Ø²Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.
 *
 * ÙˆÙ‚ØªÛŒ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ú©Ù†ØªØ±Ù„ Ù…ØµØ±Ù (quota/rate-limit) Ù†Ø¯Ø§Ø±Ø¯ØŒ
 * Ø§ÛŒÙ† handler Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ù‡ÛŒÚ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØªÛŒ Ø§Ø¹Ù…Ø§Ù„ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
 *
 * Ø¯Ø± ÙØ§Ø² Û¶ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÛŒÚ© handler ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø³Ø§Ø²ÛŒØ¯ Ùˆ Ø¯Ø± Container Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯:
 * ```php
 * $this->app->bind(SmsUsageHandler::class, MyUsageHandler::class);
 * ```
 */
class NullUsageHandler implements SmsUsageHandler
{
    /**
     * Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø¬Ø§Ø²Ù‡â€ŒÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯Ø±Ø§ÛŒÙˆØ± Ø±Ø§ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.
     *
     * @param string    $driverName Ù†Ø§Ù… Ø¯Ø±Ø§ÛŒÙˆØ±
     * @param SmsDriver $driver     Ù†Ù…ÙˆÙ†Ù‡â€ŒÛŒ Ø¯Ø±Ø§ÛŒÙˆØ±
     */
    public function ensureUsable(string $driverName, SmsDriver $driver): void
    {
        // Ø¹Ù…Ø¯Ø§Ù‹ Ø®Ø§Ù„ÛŒ â€” Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª
    }
}
```

---

## Û³. `config/sms.php` (Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ â€” Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† usage_handler)

```php
<?php

return [

    'default' => env('SMS_DRIVER', 'null'),

    'failover' => [],

    'drivers' => [

        'null' => [
            'class'       => \Karnoweb\SmsSender\Drivers\NullDriver::class,
            'credentials' => [],
        ],

    ],

    'model' => \Karnoweb\SmsSender\Models\Sms::class,

    'table' => 'sms_messages',

    /*
    |--------------------------------------------------------------------------
    | Usage Handler
    |--------------------------------------------------------------------------
    |
    | Ú©Ù„Ø§Ø³ Ù…Ø³Ø¦ÙˆÙ„ Ú©Ù†ØªØ±Ù„ Ù…ØµØ±Ù Ø¯Ø±Ø§ÛŒÙˆØ±Ù‡Ø§ (quota, rate-limit, enable/disable).
    | Ù…Ù‚Ø¯Ø§Ø± null ÛŒØ¹Ù†ÛŒ Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª (NullUsageHandler Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯).
    |
    | Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒØŒ ÛŒÚ© Ú©Ù„Ø§Ø³ Ø¨Ø³Ø§Ø²ÛŒØ¯ Ú©Ù‡ SmsUsageHandler Ø±Ø§ implement Ú©Ù†Ø¯
    | Ùˆ Ø¢Ù† Ø±Ø§ Ø¯Ø± Container bind Ú©Ù†ÛŒØ¯.
    |
    */

    'usage_handler' => null,

];
```

---

## Û´. `tests/Unit/SmsManager/BuilderTest.php`

```php
<?php

namespace Karnoweb\SmsSender\Tests\Unit\SmsManager;

use Karnoweb\SmsSender\Enums\SmsTemplateEnum;
use Karnoweb\SmsSender\SmsManager;
use Karnoweb\SmsSender\Tests\TestCase;

/**
 * ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Fluent Builder â€” Ù…ØªØ¯Ù‡Ø§ÛŒ Ø²Ù†Ø¬ÛŒØ±Ù‡â€ŒØ§ÛŒ SmsManager.
 *
 * Ø§Ø² Reflection Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ protected Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
 * ØªØ§ Ø¨ØªÙˆØ§Ù†ÛŒÙ… state Ø¯Ø§Ø®Ù„ÛŒ Builder Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒÙ… Ø¨Ø¯ÙˆÙ† ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ send().
 */
class BuilderTest extends TestCase
{
    private SmsManager $manager;

    protected function setUp(): void
    {
        parent::setUp();

        $this->manager = $this->app->make(SmsManager::class);
    }

    /**
     * Helper: Ø®ÙˆØ§Ù†Ø¯Ù† Ù…Ù‚Ø¯Ø§Ø± ÛŒÚ© property Ù…Ø­Ø§ÙØ¸Øªâ€ŒØ´Ø¯Ù‡.
     */
    private function getProperty(string $name): mixed
    {
        $reflection = new \ReflectionProperty(SmsManager::class, $name);

        return $reflection->getValue($this->manager);
    }

    // â”€â”€â”€ Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_message_sets_message_text(): void
    {
        $result = $this->manager->message('Ø³Ù„Ø§Ù… Ø¯Ù†ÛŒØ§');

        // Ø¨Ø§ÛŒØ¯ Ù‡Ù…Ø§Ù† instance Ø¨Ø±Ú¯Ø±Ø¯Ø¯ (Fluent)
        $this->assertSame($this->manager, $result);

        // Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø§Ø®Ù„ÛŒ Ø¨Ø§ÛŒØ¯ Ø³Øª Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        $this->assertEquals('Ø³Ù„Ø§Ù… Ø¯Ù†ÛŒØ§', $this->getProperty('messageText'));
    }

    public function test_message_overwrites_previous_message(): void
    {
        $this->manager->message('Ø§ÙˆÙ„')->message('Ø¯ÙˆÙ…');

        $this->assertEquals('Ø¯ÙˆÙ…', $this->getProperty('messageText'));
    }

    // â”€â”€â”€ OTP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_otp_sets_template_text_from_enum(): void
    {
        $result = $this->manager->otp(SmsTemplateEnum::LOGIN_OTP);

        $this->assertSame($this->manager, $result);
        $this->assertEquals(SmsTemplateEnum::LOGIN_OTP->value, $this->getProperty('templateText'));
    }

    public function test_otp_sets_template_name(): void
    {
        $this->manager->otp(SmsTemplateEnum::LOGIN_OTP);

        $this->assertEquals('LOGIN_OTP', $this->getProperty('templateName'));
    }

    // â”€â”€â”€ Input(s) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_input_adds_single_key_value(): void
    {
        $result = $this->manager->input('code', '1234');

        $this->assertSame($this->manager, $result);
        $this->assertEquals(['code' => '1234'], $this->getProperty('inputs'));
    }

    public function test_input_can_be_called_multiple_times(): void
    {
        $this->manager
            ->input('code', '1234')
            ->input('name', 'Ø¹Ù„ÛŒ');

        $this->assertEquals(
            ['code' => '1234', 'name' => 'Ø¹Ù„ÛŒ'],
            $this->getProperty('inputs'),
        );
    }

    public function test_input_overwrites_same_key(): void
    {
        $this->manager
            ->input('code', '1234')
            ->input('code', '5678');

        $this->assertEquals(['code' => '5678'], $this->getProperty('inputs'));
    }

    public function test_inputs_merges_array(): void
    {
        $result = $this->manager->inputs(['code' => '1234', 'name' => 'Ø¹Ù„ÛŒ']);

        $this->assertSame($this->manager, $result);
        $this->assertEquals(
            ['code' => '1234', 'name' => 'Ø¹Ù„ÛŒ'],
            $this->getProperty('inputs'),
        );
    }

    public function test_inputs_merges_with_existing(): void
    {
        $this->manager
            ->input('code', '1234')
            ->inputs(['name' => 'Ø¹Ù„ÛŒ', 'code' => '5678']);

        // 'code' Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¯ÛŒØ¯ override Ø´ÙˆØ¯
        $this->assertEquals(
            ['code' => '5678', 'name' => 'Ø¹Ù„ÛŒ'],
            $this->getProperty('inputs'),
        );
    }

    // â”€â”€â”€ Number(s) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_number_adds_single_phone(): void
    {
        $result = $this->manager->number('09120000000');

        $this->assertSame($this->manager, $result);
        $this->assertEquals(['09120000000'], $this->getProperty('toNumbers'));
    }

    public function test_number_can_be_called_multiple_times(): void
    {
        $this->manager
            ->number('09120000000')
            ->number('09130000000');

        $this->assertEquals(
            ['09120000000', '09130000000'],
            $this->getProperty('toNumbers'),
        );
    }

    public function test_numbers_adds_array_of_phones(): void
    {
        $result = $this->manager->numbers(['09120000000', '09130000000']);

        $this->assertSame($this->manager, $result);
        $this->assertEquals(
            ['09120000000', '09130000000'],
            $this->getProperty('toNumbers'),
        );
    }

    public function test_numbers_casts_to_string(): void
    {
        // Ø¹Ø¯Ø¯ integer Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ string ØªØ¨Ø¯ÛŒÙ„ Ø´ÙˆØ¯
        $this->manager->numbers([9120000000, 9130000000]);

        $numbers = $this->getProperty('toNumbers');

        foreach ($numbers as $number) {
            $this->assertIsString($number);
        }
    }

    public function test_numbers_appends_to_existing(): void
    {
        $this->manager
            ->number('09120000000')
            ->numbers(['09130000000', '09140000000']);

        $this->assertCount(3, $this->getProperty('toNumbers'));
    }

    // â”€â”€â”€ Full Chain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_full_fluent_chain_returns_same_instance(): void
    {
        $result = $this->manager
            ->otp(SmsTemplateEnum::LOGIN_OTP)
            ->input('code', '1234')
            ->number('09120000000');

        $this->assertSame($this->manager, $result);
    }
}
```

---

## Ûµ. `tests/Unit/SmsManager/TemplateCompilerTest.php`

```php
<?php

namespace Karnoweb\SmsSender\Tests\Unit\SmsManager;

use Karnoweb\SmsSender\SmsManager;
use Karnoweb\SmsSender\Tests\TestCase;

/**
 * ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Template Engine (compileTemplate).
 *
 * Ø§Ø² Reflection Ø¨Ø±Ø§ÛŒ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù…ØªØ¯ protected Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
 */
class TemplateCompilerTest extends TestCase
{
    private SmsManager $manager;

    /** @var \ReflectionMethod Ù…ØªØ¯ compileTemplate */
    private \ReflectionMethod $compileMethod;

    protected function setUp(): void
    {
        parent::setUp();

        $this->manager = $this->app->make(SmsManager::class);

        // Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ØªØ¯ protected
        $this->compileMethod = new \ReflectionMethod(SmsManager::class, 'compileTemplate');
    }

    /**
     * Helper: ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ compileTemplate.
     */
    private function compile(string $template, array $inputs = []): string
    {
        return $this->compileMethod->invoke($this->manager, $template, $inputs);
    }

    // â”€â”€â”€ Basic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_empty_inputs_returns_template_unchanged(): void
    {
        $template = 'Ø³Ù„Ø§Ù… {name}';

        $this->assertEquals($template, $this->compile($template));
        $this->assertEquals($template, $this->compile($template, []));
    }

    public function test_single_placeholder_replacement(): void
    {
        $result = $this->compile('Ú©Ø¯ ÙˆØ±ÙˆØ¯: {code}', ['code' => '1234']);

        $this->assertEquals('Ú©Ø¯ ÙˆØ±ÙˆØ¯: 1234', $result);
    }

    public function test_multiple_placeholder_replacement(): void
    {
        $result = $this->compile(
            'Ø³Ù„Ø§Ù… {name}ØŒ Ú©Ø¯ Ø´Ù…Ø§: {code}',
            ['name' => 'Ø¹Ù„ÛŒ', 'code' => '5678'],
        );

        $this->assertEquals('Ø³Ù„Ø§Ù… Ø¹Ù„ÛŒØŒ Ú©Ø¯ Ø´Ù…Ø§: 5678', $result);
    }

    // â”€â”€â”€ Edge Cases â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_placeholder_not_in_template_is_ignored(): void
    {
        // ÙˆØ±ÙˆØ¯ÛŒ 'extra' Ø¯Ø± Ù‚Ø§Ù„Ø¨ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ â€” Ù†Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ù‡Ø¯
        $result = $this->compile('Ú©Ø¯: {code}', ['code' => '1234', 'extra' => 'unused']);

        $this->assertEquals('Ú©Ø¯: 1234', $result);
    }

    public function test_unmatched_placeholder_stays_in_output(): void
    {
        // {name} Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ù†Ø´Ø¯Ù‡ â€” Ø¨Ø§ÛŒØ¯ Ù‡Ù…Ø§Ù†Ø·ÙˆØ± Ø¨Ø§Ù‚ÛŒ Ø¨Ù…Ø§Ù†Ø¯
        $result = $this->compile('Ø³Ù„Ø§Ù… {name}ØŒ Ú©Ø¯: {code}', ['code' => '1234']);

        $this->assertEquals('Ø³Ù„Ø§Ù… {name}ØŒ Ú©Ø¯: 1234', $result);
    }

    public function test_template_without_placeholders(): void
    {
        $result = $this->compile('Ù¾ÛŒØ§Ù… Ø«Ø§Ø¨Øª Ø¨Ø¯ÙˆÙ† Ù…ØªØºÛŒØ±', ['code' => '1234']);

        $this->assertEquals('Ù¾ÛŒØ§Ù… Ø«Ø§Ø¨Øª Ø¨Ø¯ÙˆÙ† Ù…ØªØºÛŒØ±', $result);
    }

    public function test_empty_template(): void
    {
        $result = $this->compile('', ['code' => '1234']);

        $this->assertEquals('', $result);
    }

    public function test_same_placeholder_used_twice(): void
    {
        // ÛŒÚ© placeholder Ú©Ù‡ Ø¯Ùˆ Ø¨Ø§Ø± Ø¯Ø± Ù‚Ø§Ù„Ø¨ Ø¢Ù…Ø¯Ù‡
        $result = $this->compile('Ú©Ø¯: {code} â€” ØªÚ©Ø±Ø§Ø±: {code}', ['code' => '1234']);

        $this->assertEquals('Ú©Ø¯: 1234 â€” ØªÚ©Ø±Ø§Ø±: 1234', $result);
    }

    public function test_numeric_value_is_cast_to_string(): void
    {
        $result = $this->compile('Ø¹Ø¯Ø¯: {num}', ['num' => 42]);

        $this->assertEquals('Ø¹Ø¯Ø¯: 42', $result);
    }

    // â”€â”€â”€ Persian / Unicode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_persian_placeholder_values(): void
    {
        $result = $this->compile('Ø³Ù„Ø§Ù… {name}', ['name' => 'Ù…Ø­Ù…Ø¯']);

        $this->assertEquals('Ø³Ù„Ø§Ù… Ù…Ø­Ù…Ø¯', $result);
    }

    public function test_persian_template_with_numbers(): void
    {
        $result = $this->compile('Ú©Ø¯ ØªØ£ÛŒÛŒØ¯ Ø´Ù…Ø§: {code}', ['code' => 'Û±Û²Û³Û´']);

        $this->assertEquals('Ú©Ø¯ ØªØ£ÛŒÛŒØ¯ Ø´Ù…Ø§: Û±Û²Û³Û´', $result);
    }
}
```

---

## Û¶. `tests/Unit/SmsManager/DriverResolutionTest.php`

```php
<?php

namespace Karnoweb\SmsSender\Tests\Unit\SmsManager;

use Karnoweb\SmsSender\Contracts\SmsDriver;
use Karnoweb\SmsSender\Drivers\NullDriver;
use Karnoweb\SmsSender\Exceptions\InvalidDriverConfigurationException;
use Karnoweb\SmsSender\SmsManager;
use Karnoweb\SmsSender\Tests\TestCase;

/**
 * ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Resolve Ø¯Ø±Ø§ÛŒÙˆØ± Ùˆ ØªØ±ØªÛŒØ¨ Failover.
 */
class DriverResolutionTest extends TestCase
{
    private SmsManager $manager;

    /** @var \ReflectionMethod */
    private \ReflectionMethod $resolveDriverMethod;

    /** @var \ReflectionMethod */
    private \ReflectionMethod $getDriverOrderMethod;

    protected function setUp(): void
    {
        parent::setUp();

        $this->manager = $this->app->make(SmsManager::class);

        $this->resolveDriverMethod  = new \ReflectionMethod(SmsManager::class, 'resolveDriver');
        $this->getDriverOrderMethod = new \ReflectionMethod(SmsManager::class, 'getDriverOrder');
    }

    // â”€â”€â”€ getDriverOrder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_default_driver_is_first_in_order(): void
    {
        // Ø¨Ø§ config Ù¾ÛŒØ´â€ŒÙØ±Ø¶ØŒ ÙÙ‚Ø· 'null' Ø¨Ø§ÛŒØ¯ Ø¨Ø§Ø´Ø¯
        $order = $this->getDriverOrderMethod->invoke($this->manager);

        $this->assertEquals(['null'], $order);
    }

    public function test_failover_drivers_come_after_default(): void
    {
        // ØªÙ†Ø¸ÛŒÙ… failover
        config([
            'sms.default'  => 'driver_a',
            'sms.failover' => ['driver_b', 'driver_c'],
        ]);

        $order = $this->getDriverOrderMethod->invoke($this->manager);

        $this->assertEquals(['driver_a', 'driver_b', 'driver_c'], $order);
    }

    public function test_duplicate_drivers_are_removed(): void
    {
        // default Ø¯Ø± failover Ù‡Ù… Ù‡Ø³Øª â€” Ù†Ø¨Ø§ÛŒØ¯ ØªÚ©Ø±Ø§Ø±ÛŒ Ø¨Ø§Ø´Ø¯
        config([
            'sms.default'  => 'driver_a',
            'sms.failover' => ['driver_a', 'driver_b'],
        ]);

        $order = $this->getDriverOrderMethod->invoke($this->manager);

        $this->assertEquals(['driver_a', 'driver_b'], $order);
    }

    public function test_empty_config_throws_exception(): void
    {
        config([
            'sms.default'  => null,
            'sms.failover' => [],
        ]);

        $this->expectException(InvalidDriverConfigurationException::class);
        $this->expectExceptionMessage('No SMS driver configured');

        $this->getDriverOrderMethod->invoke($this->manager);
    }

    public function test_empty_default_with_failover_still_works(): void
    {
        config([
            'sms.default'  => '',
            'sms.failover' => ['driver_a'],
        ]);

        $order = $this->getDriverOrderMethod->invoke($this->manager);

        $this->assertEquals(['driver_a'], $order);
    }

    // â”€â”€â”€ resolveDriver â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_resolve_null_driver(): void
    {
        $driver = $this->resolveDriverMethod->invoke($this->manager, 'null');

        $this->assertInstanceOf(NullDriver::class, $driver);
        $this->assertInstanceOf(SmsDriver::class, $driver);
    }

    public function test_resolve_undefined_driver_throws_exception(): void
    {
        $this->expectException(InvalidDriverConfigurationException::class);
        $this->expectExceptionMessage('not defined');

        $this->resolveDriverMethod->invoke($this->manager, 'nonexistent');
    }

    public function test_resolve_driver_without_class_throws_exception(): void
    {
        config(['sms.drivers.broken' => ['credentials' => []]]);

        $this->expectException(InvalidDriverConfigurationException::class);
        $this->expectExceptionMessage('not specified');

        $this->resolveDriverMethod->invoke($this->manager, 'broken');
    }

    public function test_resolve_driver_with_nonexistent_class_throws_exception(): void
    {
        config(['sms.drivers.broken' => [
            'class'       => 'App\\NonExistent\\Driver',
            'credentials' => [],
        ]]);

        $this->expectException(InvalidDriverConfigurationException::class);
        $this->expectExceptionMessage('does not exist');

        $this->resolveDriverMethod->invoke($this->manager, 'broken');
    }

    public function test_resolve_driver_not_implementing_interface_throws_exception(): void
    {
        // ÛŒÚ© Ú©Ù„Ø§Ø³ ÙˆØ§Ù‚Ø¹ÛŒ Ú©Ù‡ SmsDriver Ø±Ø§ implement Ù†Ú©Ø±Ø¯Ù‡
        config(['sms.drivers.invalid' => [
            'class'       => \stdClass::class,
            'credentials' => [],
        ]]);

        $this->expectException(InvalidDriverConfigurationException::class);
        $this->expectExceptionMessage('must implement');

        $this->resolveDriverMethod->invoke($this->manager, 'invalid');
    }

    public function test_resolve_driver_passes_credentials(): void
    {
        // Ø³Ø§Ø®Øª ÛŒÚ© Ø¯Ø±Ø§ÛŒÙˆØ± ØªØ³ØªÛŒ Ú©Ù‡ config Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        config(['sms.drivers.test_driver' => [
            'class'       => NullDriver::class,
            'credentials' => ['api_key' => 'test_123'],
        ]]);

        $driver = $this->resolveDriverMethod->invoke($this->manager, 'test_driver');

        // NullDriver Ø¨Ø§ config Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡
        $this->assertInstanceOf(NullDriver::class, $driver);
    }
}
```

---

## Û·. `tests/Unit/SmsManager/ResetTest.php`

```php
<?php

namespace Karnoweb\SmsSender\Tests\Unit\SmsManager;

use Karnoweb\SmsSender\Enums\SmsTemplateEnum;
use Karnoweb\SmsSender\SmsManager;
use Karnoweb\SmsSender\Tests\TestCase;

/**
 * ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø±ÛŒØ³Øª State Ø¨Ø¹Ø¯ Ø§Ø² Ø¹Ù…Ù„ÛŒØ§Øª.
 *
 * Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ Singleton instance Ø¨Ø¹Ø¯ Ø§Ø² Ù‡Ø± send() Ù¾Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯
 * Ùˆ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø¨Ø¹Ø¯ÛŒ Ø¨Ø§ state ØªÙ…ÛŒØ² Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
 */
class ResetTest extends TestCase
{
    private SmsManager $manager;

    protected function setUp(): void
    {
        parent::setUp();

        $this->manager = $this->app->make(SmsManager::class);
    }

    private function getProperty(string $name): mixed
    {
        $reflection = new \ReflectionProperty(SmsManager::class, $name);

        return $reflection->getValue($this->manager);
    }

    private function callReset(): void
    {
        $method = new \ReflectionMethod(SmsManager::class, 'reset');
        $method->invoke($this->manager);
    }

    public function test_reset_clears_all_builder_state(): void
    {
        // Ù¾Ø± Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§
        $this->manager
            ->otp(SmsTemplateEnum::LOGIN_OTP)
            ->input('code', '1234')
            ->number('09120000000')
            ->numbers(['09130000000']);

        // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ù¾Ø± Ù‡Ø³ØªÙ†Ø¯
        $this->assertNotEmpty($this->getProperty('toNumbers'));
        $this->assertNotNull($this->getProperty('templateText'));
        $this->assertNotNull($this->getProperty('templateName'));
        $this->assertNotEmpty($this->getProperty('inputs'));

        // Ø±ÛŒØ³Øª
        $this->callReset();

        // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ù‡Ù…Ù‡ Ú†ÛŒØ² Ù¾Ø§Ú© Ø´Ø¯Ù‡
        $this->assertEmpty($this->getProperty('toNumbers'));
        $this->assertNull($this->getProperty('messageText'));
        $this->assertNull($this->getProperty('templateText'));
        $this->assertNull($this->getProperty('templateName'));
        $this->assertEmpty($this->getProperty('inputs'));
    }

    public function test_reset_clears_message_text(): void
    {
        $this->manager->message('Ø³Ù„Ø§Ù…');
        $this->callReset();

        $this->assertNull($this->getProperty('messageText'));
    }

    public function test_reset_allows_clean_reuse(): void
    {
        // Ø§ÙˆÙ„: Ø³Øª Ú©Ø±Ø¯Ù† ÛŒÚ© Ù…Ù‚Ø¯Ø§Ø±
        $this->manager->message('Ø§ÙˆÙ„')->number('09120000000');
        $this->callReset();

        // Ø¯ÙˆÙ…: Ø³Øª Ú©Ø±Ø¯Ù† Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¯ÛŒØ¯
        $this->manager->message('Ø¯ÙˆÙ…')->number('09130000000');

        // Ø¨Ø§ÛŒØ¯ ÙÙ‚Ø· Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¬Ø¯ÛŒØ¯ Ø¨Ø§Ø´Ø¯
        $this->assertEquals('Ø¯ÙˆÙ…', $this->getProperty('messageText'));
        $this->assertEquals(['09130000000'], $this->getProperty('toNumbers'));
    }
}
```

---

## Û¸. `tests/Feature/SendTest.php`

```php
<?php

namespace Karnoweb\SmsSender\Tests\Feature;

use Illuminate\Foundation\Testing\RefreshDatabase;
use Karnoweb\SmsSender\Contracts\SmsDriver;
use Karnoweb\SmsSender\Enums\SmsSendStatusEnum;
use Karnoweb\SmsSender\Enums\SmsTemplateEnum;
use Karnoweb\SmsSender\Exceptions\InvalidDriverConfigurationException;
use Karnoweb\SmsSender\Facades\Sms;
use Karnoweb\SmsSender\Models\Sms as SmsModel;
use Karnoweb\SmsSender\SmsManager;
use Karnoweb\SmsSender\Tests\TestCase;

/**
 * ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…Ú© (Integration).
 *
 * Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ÙˆØ§Ù‚Ø¹ÛŒ (SQLite in-memory) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
 * ØªØ§ Ø«Ø¨Øª Ù„Ø§Ú¯ Ùˆ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ø´ÙˆÙ†Ø¯.
 */
class SendTest extends TestCase
{
    use RefreshDatabase;

    protected function defineDatabaseMigrations(): void
    {
        $this->loadMigrationsFrom(__DIR__ . '/../../database/migrations');
    }

    // â”€â”€â”€ Validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_send_without_recipients_throws_exception(): void
    {
        $this->expectException(InvalidDriverConfigurationException::class);
        $this->expectExceptionMessage('No recipients');

        Sms::message('Ø³Ù„Ø§Ù…')->send();
    }

    public function test_send_without_message_throws_exception(): void
    {
        $this->expectException(InvalidDriverConfigurationException::class);
        $this->expectExceptionMessage('No message');

        Sms::number('09120000000')->send();
    }

    public function test_send_without_anything_throws_exception(): void
    {
        $this->expectException(InvalidDriverConfigurationException::class);

        Sms::send();
    }

    // â”€â”€â”€ Simple Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_send_simple_message(): void
    {
        Sms::message('Ø³Ù„Ø§Ù… Ø¯Ù†ÛŒØ§')
            ->number('09120000000')
            ->send();

        // Ø¨Ø§ÛŒØ¯ ÛŒÚ© Ø±Ú©ÙˆØ±Ø¯ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        $this->assertDatabaseCount('sms_messages', 1);

        $this->assertDatabaseHas('sms_messages', [
            'phone'   => '09120000000',
            'message' => 'Ø³Ù„Ø§Ù… Ø¯Ù†ÛŒØ§',
            'driver'  => 'null',
            'status'  => SmsSendStatusEnum::SENT->value,
        ]);
    }

    public function test_send_to_multiple_numbers(): void
    {
        Sms::message('Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ')
            ->numbers(['09120000000', '09130000000', '09140000000'])
            ->send();

        // Ø¨Ø§ÛŒØ¯ Û³ Ø±Ú©ÙˆØ±Ø¯ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        $this->assertDatabaseCount('sms_messages', 3);
    }

    public function test_duplicate_numbers_are_sent_once(): void
    {
        Sms::message('ØªØ³Øª')
            ->number('09120000000')
            ->number('09120000000')
            ->numbers(['09120000000'])
            ->send();

        // Ø´Ù…Ø§Ø±Ù‡â€ŒÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ø¨Ø§ÛŒØ¯ ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø± Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯
        $this->assertDatabaseCount('sms_messages', 1);
    }

    // â”€â”€â”€ OTP Template â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_send_otp_with_template(): void
    {
        Sms::otp(SmsTemplateEnum::LOGIN_OTP)
            ->input('code', '1234')
            ->number('09120000000')
            ->send();

        $this->assertDatabaseHas('sms_messages', [
            'phone'    => '09120000000',
            'message'  => 'Ú©Ø¯ ÙˆØ±ÙˆØ¯ Ø´Ù…Ø§: 1234',
            'template' => 'LOGIN_OTP',
            'status'   => SmsSendStatusEnum::SENT->value,
        ]);
    }

    public function test_otp_template_inputs_are_stored(): void
    {
        Sms::otp(SmsTemplateEnum::LOGIN_OTP)
            ->input('code', '5678')
            ->number('09120000000')
            ->send();

        $record = SmsModel::first();

        $this->assertEquals(['code' => '5678'], $record->inputs);
    }

    // â”€â”€â”€ Message Priority over Template â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_message_takes_priority_over_template(): void
    {
        // Ø§Ú¯Ø± Ù‡Ù… message Ùˆ Ù‡Ù… otp Ø³Øª Ø´ÙˆÙ†Ø¯ØŒ message Ø§ÙˆÙ„ÙˆÛŒØª Ø¯Ø§Ø±Ø¯
        Sms::otp(SmsTemplateEnum::LOGIN_OTP)
            ->input('code', '1234')
            ->message('Ù¾ÛŒØ§Ù… Ø³Ø§Ø¯Ù‡')
            ->number('09120000000')
            ->send();

        $this->assertDatabaseHas('sms_messages', [
            'message' => 'Ù¾ÛŒØ§Ù… Ø³Ø§Ø¯Ù‡',
        ]);
    }

    // â”€â”€â”€ State Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_state_is_reset_after_send(): void
    {
        Sms::message('Ø§ÙˆÙ„')
            ->number('09120000000')
            ->send();

        // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø¯ÙˆÙ… Ø¨Ø¯ÙˆÙ† ØªÙ†Ø¸ÛŒÙ… Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ø¨Ø¯Ù‡Ø¯ (state Ù¾Ø§Ú© Ø´Ø¯Ù‡)
        $this->expectException(InvalidDriverConfigurationException::class);

        Sms::send();
    }

    public function test_state_is_reset_even_after_exception(): void
    {
        // Ø§Ø±Ø³Ø§Ù„ Ø¨Ø¯ÙˆÙ† Ú¯ÛŒØ±Ù†Ø¯Ù‡ â†’ Exception
        try {
            Sms::message('ØªØ³Øª')->send();
        } catch (InvalidDriverConfigurationException) {
            // Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø§Ø±ÛŒÙ…
        }

        // state Ø¨Ø§ÛŒØ¯ Ù¾Ø§Ú© Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ â€” message Ù‚Ø¨Ù„ÛŒ Ù†Ø¨Ø§ÛŒØ¯ Ø¨Ø§Ù‚ÛŒ Ø¨Ù…Ø§Ù†Ø¯
        $this->expectException(InvalidDriverConfigurationException::class);
        $this->expectExceptionMessage('No recipients');

        // Ø§Ú¯Ø± message Ù‡Ù†ÙˆØ² Ø¨ÙˆØ¯ØŒ Ø®Ø·Ø§ 'No recipients' Ø¨ÙˆØ¯
        // Ø§Ú¯Ø± reset Ù†Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ message 'ØªØ³Øª' Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯
        Sms::number('09120000000')->send();
    }

    public function test_sequential_sends_are_independent(): void
    {
        Sms::message('Ù¾ÛŒØ§Ù… Ø§ÙˆÙ„')
            ->number('09120000000')
            ->send();

        Sms::message('Ù¾ÛŒØ§Ù… Ø¯ÙˆÙ…')
            ->number('09130000000')
            ->send();

        $this->assertDatabaseCount('sms_messages', 2);

        // Ù¾ÛŒØ§Ù… Ø§ÙˆÙ„ Ù†Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡ Ø¯ÙˆÙ… Ø±ÙØªÙ‡ Ø¨Ø§Ø´Ø¯
        $this->assertDatabaseHas('sms_messages', [
            'phone'   => '09120000000',
            'message' => 'Ù¾ÛŒØ§Ù… Ø§ÙˆÙ„',
        ]);

        $this->assertDatabaseHas('sms_messages', [
            'phone'   => '09130000000',
            'message' => 'Ù¾ÛŒØ§Ù… Ø¯ÙˆÙ…',
        ]);
    }

    // â”€â”€â”€ Using Facade â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_facade_sends_successfully(): void
    {
        Sms::message('ØªØ³Øª Facade')
            ->number('09120000000')
            ->send();

        $this->assertDatabaseHas('sms_messages', [
            'message' => 'ØªØ³Øª Facade',
        ]);
    }

    // â”€â”€â”€ Record Details â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_record_stores_driver_name(): void
    {
        Sms::message('ØªØ³Øª')->number('09120000000')->send();

        $record = SmsModel::first();

        $this->assertEquals('null', $record->driver);
    }

    public function test_record_without_template_has_null_template(): void
    {
        Sms::message('Ø³Ø§Ø¯Ù‡')->number('09120000000')->send();

        $record = SmsModel::first();

        $this->assertNull($record->template);
        $this->assertNull($record->inputs);
    }
}
```

---

## Û¹. `tests/Feature/FailoverTest.php`

```php
<?php

namespace Karnoweb\SmsSender\Tests\Feature;

use Illuminate\Foundation\Testing\RefreshDatabase;
use Karnoweb\SmsSender\Contracts\SmsDriver;
use Karnoweb\SmsSender\Exceptions\DriverConnectionException;
use Karnoweb\SmsSender\Exceptions\DriverNotAvailableException;
use Karnoweb\SmsSender\Exceptions\InvalidDriverConfigurationException;
use Karnoweb\SmsSender\Facades\Sms;
use Karnoweb\SmsSender\Models\Sms as SmsModel;
use Karnoweb\SmsSender\Enums\SmsSendStatusEnum;
use Karnoweb\SmsSender\Tests\TestCase;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Ø¯Ø±Ø§ÛŒÙˆØ±Ù‡Ø§ÛŒ ØªØ³ØªÛŒ (Fake Drivers)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * Ø¯Ø±Ø§ÛŒÙˆØ± ØªØ³ØªÛŒ Ú©Ù‡ Ù‡Ù…ÛŒØ´Ù‡ DriverConnectionException Ù¾Ø±ØªØ§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
 * Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ÛŒÚ© Ø³Ø±ÙˆÛŒØ³â€ŒØ¯Ù‡Ù†Ø¯Ù‡â€ŒÛŒ Ø§Ø² Ø¯Ø³ØªØ±Ø³ Ø®Ø§Ø±Ø¬.
 */
class FailingDriver implements SmsDriver
{
    public function __construct(protected readonly array $config = []) {}

    public function send(string $phone, string $message): void
    {
        throw new DriverConnectionException('Simulated connection failure');
    }
}

/**
 * Ø¯Ø±Ø§ÛŒÙˆØ± ØªØ³ØªÛŒ Ú©Ù‡ Ø§Ø±Ø³Ø§Ù„â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø± ÛŒÚ© Ø¢Ø±Ø§ÛŒÙ‡â€ŒÛŒ Ø§Ø³ØªØ§ØªÛŒÚ© Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
 * Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ ÙˆØ§Ù‚Ø¹Ø§Ù‹ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø´Ø¯Ù‡ ÛŒØ§ Ù†Ù‡.
 */
class RecordingDriver implements SmsDriver
{
    /** @var array<int, array{phone: string, message: string}> */
    public static array $sent = [];

    public function __construct(protected readonly array $config = []) {}

    public function send(string $phone, string $message): void
    {
        static::$sent[] = ['phone' => $phone, 'message' => $message];
    }
}

/**
 * Ø¯Ø±Ø§ÛŒÙˆØ± ØªØ³ØªÛŒ Ú©Ù‡ ÛŒÚ© RuntimeException ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ù¾Ø±ØªØ§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
 * Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¨Ø§Ú¯â€ŒÙ‡Ø§ Failover Ø±Ø§ ÙØ¹Ø§Ù„ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯.
 */
class BuggyDriver implements SmsDriver
{
    public function __construct(protected readonly array $config = []) {}

    public function send(string $phone, string $message): void
    {
        throw new \RuntimeException('Unexpected bug in driver');
    }
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ØªØ³Øªâ€ŒÙ‡Ø§
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ú©Ø§Ù†ÛŒØ²Ù… Failover.
 *
 * Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§:
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Û±. Ø¯Ø±Ø§ÛŒÙˆØ± Ø§ÙˆÙ„ Ù…ÙˆÙÙ‚ â†’ Failover ÙØ¹Ø§Ù„ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯
 * Û². Ø¯Ø±Ø§ÛŒÙˆØ± Ø§ÙˆÙ„ Ø´Ú©Ø³Øª â†’ Ø³ÙˆØ¦ÛŒÚ† Ø¨Ù‡ Ø¯Ø±Ø§ÛŒÙˆØ± Ø¯ÙˆÙ…
 * Û³. Ù‡Ù…Ù‡ Ø¯Ø±Ø§ÛŒÙˆØ±Ù‡Ø§ Ø´Ú©Ø³Øª â†’ DriverNotAvailableException
 * Û´. Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ (bug) â†’ Ø¨Ø¯ÙˆÙ† FailoverØŒ bubble up
 * Ûµ. Ø¯Ø±Ø§ÛŒÙˆØ± Ø§ÙˆÙ„ Ø´Ú©Ø³Øª â†’ Ø±Ú©ÙˆØ±Ø¯ FAILED + Ø¯Ø±Ø§ÛŒÙˆØ± Ø¯ÙˆÙ… Ù…ÙˆÙÙ‚ â†’ Ø±Ú©ÙˆØ±Ø¯ SENT
 */
class FailoverTest extends TestCase
{
    use RefreshDatabase;

    protected function defineDatabaseMigrations(): void
    {
        $this->loadMigrationsFrom(__DIR__ . '/../../database/migrations');
    }

    protected function setUp(): void
    {
        parent::setUp();

        // Ø±ÛŒØ³Øª Ø¯Ø±Ø§ÛŒÙˆØ± Ø¶Ø¨Ø·â€ŒÚ©Ù†Ù†Ø¯Ù‡ Ù‚Ø¨Ù„ Ø§Ø² Ù‡Ø± ØªØ³Øª
        RecordingDriver::$sent = [];
    }

    // â”€â”€â”€ Scenario 1: First Driver Succeeds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_first_driver_success_no_failover(): void
    {
        config([
            'sms.default'  => 'recording',
            'sms.failover' => ['failing'],
            'sms.drivers.recording' => [
                'class'       => RecordingDriver::class,
                'credentials' => [],
            ],
            'sms.drivers.failing' => [
                'class'       => FailingDriver::class,
                'credentials' => [],
            ],
        ]);

        Sms::message('ØªØ³Øª')->number('09120000000')->send();

        // ÙÙ‚Ø· Ø¯Ø±Ø§ÛŒÙˆØ± Ø§ÙˆÙ„ Ø¨Ø§ÛŒØ¯ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        $this->assertCount(1, RecordingDriver::$sent);
        $this->assertEquals('09120000000', RecordingDriver::$sent[0]['phone']);

        // Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø§ÛŒØ¯ SENT Ø¨Ø§Ø´Ø¯
        $this->assertDatabaseHas('sms_messages', [
            'driver' => 'recording',
            'status' => SmsSendStatusEnum::SENT->value,
        ]);
    }

    // â”€â”€â”€ Scenario 2: Failover to Second Driver â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_failover_to_second_driver_on_connection_error(): void
    {
        config([
            'sms.default'  => 'failing',
            'sms.failover' => ['recording'],
            'sms.drivers.failing' => [
                'class'       => FailingDriver::class,
                'credentials' => [],
            ],
            'sms.drivers.recording' => [
                'class'       => RecordingDriver::class,
                'credentials' => [],
            ],
        ]);

        Sms::message('ØªØ³Øª failover')->number('09120000000')->send();

        // Ø¯Ø±Ø§ÛŒÙˆØ± Ø¯ÙˆÙ… Ø¨Ø§ÛŒØ¯ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        $this->assertCount(1, RecordingDriver::$sent);

        // Ø¨Ø§ÛŒØ¯ Û² Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø§Ø´Ø¯: ÛŒÚ©ÛŒ FAILED (failing) Ùˆ ÛŒÚ©ÛŒ SENT (recording)
        $this->assertDatabaseHas('sms_messages', [
            'driver' => 'failing',
            'status' => SmsSendStatusEnum::FAILED->value,
        ]);

        $this->assertDatabaseHas('sms_messages', [
            'driver' => 'recording',
            'status' => SmsSendStatusEnum::SENT->value,
        ]);
    }

    // â”€â”€â”€ Scenario 3: All Drivers Fail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_all_drivers_fail_throws_not_available(): void
    {
        config([
            'sms.default'  => 'failing1',
            'sms.failover' => ['failing2'],
            'sms.drivers.failing1' => [
                'class'       => FailingDriver::class,
                'credentials' => [],
            ],
            'sms.drivers.failing2' => [
                'class'       => FailingDriver::class,
                'credentials' => [],
            ],
        ]);

        $this->expectException(DriverNotAvailableException::class);
        $this->expectExceptionMessage('No SMS drivers are available');

        Sms::message('ØªØ³Øª Ø´Ú©Ø³Øª')->number('09120000000')->send();
    }

    public function test_not_available_exception_chains_last_error(): void
    {
        config([
            'sms.default'  => 'failing',
            'sms.failover' => [],
            'sms.drivers.failing' => [
                'class'       => FailingDriver::class,
                'credentials' => [],
            ],
        ]);

        try {
            Sms::message('ØªØ³Øª')->number('09120000000')->send();
            $this->fail('Expected DriverNotAvailableException');
        } catch (DriverNotAvailableException $e) {
            // previous Ø¨Ø§ÛŒØ¯ DriverConnectionException Ø¨Ø§Ø´Ø¯
            $this->assertInstanceOf(DriverConnectionException::class, $e->getPrevious());
        }
    }

    // â”€â”€â”€ Scenario 4: Unexpected Bug â€” No Failover â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_unexpected_exception_bubbles_up_without_failover(): void
    {
        config([
            'sms.default'  => 'buggy',
            'sms.failover' => ['recording'],
            'sms.drivers.buggy' => [
                'class'       => BuggyDriver::class,
                'credentials' => [],
            ],
            'sms.drivers.recording' => [
                'class'       => RecordingDriver::class,
                'credentials' => [],
            ],
        ]);

        // RuntimeException Ø¨Ø§ÛŒØ¯ Ø¨Ø¯ÙˆÙ† Failover Ø¨Ù‡ Ø¨Ø§Ù„Ø§ Ø¨Ø±ÙˆØ¯
        $this->expectException(\RuntimeException::class);
        $this->expectExceptionMessage('Unexpected bug');

        Sms::message('ØªØ³Øª Ø¨Ø§Ú¯')->number('09120000000')->send();
    }

    public function test_unexpected_exception_does_not_trigger_second_driver(): void
    {
        config([
            'sms.default'  => 'buggy',
            'sms.failover' => ['recording'],
            'sms.drivers.buggy' => [
                'class'       => BuggyDriver::class,
                'credentials' => [],
            ],
            'sms.drivers.recording' => [
                'class'       => RecordingDriver::class,
                'credentials' => [],
            ],
        ]);

        try {
            Sms::message('ØªØ³Øª')->number('09120000000')->send();
        } catch (\RuntimeException) {
            // Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø§Ø±ÛŒÙ…
        }

        // Ø¯Ø±Ø§ÛŒÙˆØ± Ø¯ÙˆÙ… Ù†Ø¨Ø§ÛŒØ¯ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        $this->assertEmpty(RecordingDriver::$sent);
    }

    // â”€â”€â”€ Scenario 5: Config Error Triggers Failover â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_invalid_config_triggers_failover(): void
    {
        config([
            'sms.default'  => 'broken',
            'sms.failover' => ['recording'],
            // Ø¯Ø±Ø§ÛŒÙˆØ± broken Ø§ØµÙ„Ø§Ù‹ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ â†’ InvalidDriverConfigurationException
            'sms.drivers.recording' => [
                'class'       => RecordingDriver::class,
                'credentials' => [],
            ],
        ]);

        Sms::message('ØªØ³Øª config Ø®Ø±Ø§Ø¨')->number('09120000000')->send();

        // Ø¯Ø±Ø§ÛŒÙˆØ± Ø¯ÙˆÙ… Ø¨Ø§ÛŒØ¯ Ù…ÙˆÙÙ‚ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        $this->assertCount(1, RecordingDriver::$sent);
    }

    // â”€â”€â”€ Scenario 6: Multiple Recipients with Failover â”€â”€â”€â”€â”€

    public function test_failover_resends_all_numbers_with_new_driver(): void
    {
        config([
            'sms.default'  => 'failing',
            'sms.failover' => ['recording'],
            'sms.drivers.failing' => [
                'class'       => FailingDriver::class,
                'credentials' => [],
            ],
            'sms.drivers.recording' => [
                'class'       => RecordingDriver::class,
                'credentials' => [],
            ],
        ]);

        Sms::message('ØªØ³Øª')
            ->numbers(['09120000000', '09130000000'])
            ->send();

        // Ø¯Ø±Ø§ÛŒÙˆØ± Ø¯ÙˆÙ… Ø¨Ø§ÛŒØ¯ Ù‡Ø± Ø¯Ùˆ Ø´Ù…Ø§Ø±Ù‡ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        $this->assertCount(2, RecordingDriver::$sent);
    }

    // â”€â”€â”€ State Reset After Failover â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    public function test_state_resets_after_failover_exception(): void
    {
        config([
            'sms.default'  => 'failing',
            'sms.failover' => [],
            'sms.drivers.failing' => [
                'class'       => FailingDriver::class,
                'credentials' => [],
            ],
        ]);

        try {
            Sms::message('ØªØ³Øª')->number('09120000000')->send();
        } catch (DriverNotAvailableException) {
            // Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø§Ø±ÛŒÙ…
        }

        // state Ø¨Ø§ÛŒØ¯ Ù¾Ø§Ú© Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        $this->expectException(InvalidDriverConfigurationException::class);
        Sms::send();
    }
}
```

---

## âœ… Ú†Ú©â€ŒÙ„ÛŒØ³Øª ÙØ§Ø² Û´

| Ø¢ÛŒØªÙ… | ÙˆØ¶Ø¹ÛŒØª |
|---|---|
| `SmsManager` â€” Builder: message(), otp(), input(), inputs() | âœ… |
| `SmsManager` â€” Builder: number(), numbers() | âœ… |
| `SmsManager` â€” resolveTargets() Ø¨Ø§ array_unique | âœ… |
| `SmsManager` â€” resolveMessage() Ø¨Ø§ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ | âœ… |
| `SmsManager` â€” compileTemplate() Ø¨Ø§ placeholder replacement | âœ… |
| `SmsManager` â€” getDriverOrder() Ø¨Ø§ default + failover | âœ… |
| `SmsManager` â€” resolveDriver() Ø¨Ø§ Container Ùˆ validation | âœ… |
| `SmsManager` â€” send() Ø¨Ø§ try/finally reset | âœ… |
| `SmsManager` â€” sendToTargets() Ø¨Ø§ Failover loop | âœ… |
| `SmsManager` â€” sendWithDriver() Ø¨Ø§ Ù„Ø§Ú¯ PENDING â†’ SENT/FAILED | âœ… |
| `SmsManager` â€” reset() Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† state | âœ… |
| `NullUsageHandler` â€” Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ | âœ… |
| ØªØ³Øª Builder â€” message, otp, input, inputs, number, numbers | âœ… |
| ØªØ³Øª Template Compiler â€” Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒØŒ edge casesØŒ ÙØ§Ø±Ø³ÛŒ | âœ… |
| ØªØ³Øª Driver Resolution â€” resolve, order, validation | âœ… |
| ØªØ³Øª Reset â€” Ù¾Ø§Ú©â€ŒØ´Ø¯Ù† state | âœ… |
| ØªØ³Øª Send â€” validation, simple, multiple, OTP, priority, state | âœ… |
| ØªØ³Øª Failover â€” Û¶ Ø³Ù†Ø§Ø±ÛŒÙˆ Ø´Ø§Ù…Ù„ success, failover, all-fail, bug, config, multi-recipient | âœ… |
| Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ø¬Ø§Ù…Ø¹ | âœ… |

---

**ÙØ§Ø² Û´ Ú©Ø§Ù…Ù„ Ø´Ø¯.** Ø¨Ø±ÛŒÙ… ÙØ§Ø² Ûµ (Delivery Report â€” `checkStatus()`)ØŸ