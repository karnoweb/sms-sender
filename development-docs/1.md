

# فاز ۱ — اسکلت پکیج و Config

## ساختار نهایی

```
sms-sender/
├── composer.json
├── config/
│   └── sms.php
├── database/
│   └── migrations/
│       └── .gitkeep
├── src/
│   ├── SmsManager.php
│   ├── SmsServiceProvider.php
│   ├── Drivers/
│   │   └── NullDriver.php
│   └── Facades/
│       └── Sms.php
└── tests/
    ├── TestCase.php
    └── Feature/
        └── ServiceProviderTest.php
```

---

## ۱. `composer.json`

```json
{
    "name": "karnoweb/sms-sender",
    "description": "A fluent SMS manager for Laravel with multi-driver support and automatic failover.",
    "type": "library",
    "license": "MIT",
    "keywords": [
        "laravel",
        "sms",
        "failover",
        "fluent",
        "multi-driver"
    ],
    "authors": [
        {
            "name": "Karnoweb",
            "homepage": "https://github.com/karnoweb"
        }
    ],
    "require": {
        "php": "^8.2",
        "illuminate/contracts": "^11.0|^12.0",
        "illuminate/config": "^11.0|^12.0",
        "illuminate/container": "^11.0|^12.0",
        "illuminate/database": "^11.0|^12.0",
        "illuminate/support": "^11.0|^12.0"
    },
    "require-dev": {
        "orchestra/testbench": "^9.0|^10.0",
        "phpunit/phpunit": "^11.0"
    },
    "autoload": {
        "psr-4": {
            "Karnoweb\\SmsSender\\": "src/"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "Karnoweb\\SmsSender\\Tests\\": "tests/"
        }
    },
    "extra": {
        "laravel": {
            "providers": [
                "Karnoweb\\SmsSender\\SmsServiceProvider"
            ],
            "aliases": {
                "Sms": "Karnoweb\\SmsSender\\Facades\\Sms"
            }
        }
    },
    "config": {
        "sort-packages": true
    },
    "minimum-stability": "dev",
    "prefer-stable": true
}
```

---

## ۲. `config/sms.php`

```php
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Default SMS Driver
    |--------------------------------------------------------------------------
    |
    | نام درایور پیش‌فرض برای ارسال پیامک.
    | این مقدار باید دقیقاً با یکی از کلیدهای آرایه‌ی 'drivers' مطابقت داشته باشد.
    | در محیط توسعه از 'null' استفاده کنید تا پیامک واقعی ارسال نشود.
    |
    */

    'default' => env('SMS_DRIVER', 'null'),

    /*
    |--------------------------------------------------------------------------
    | Failover Drivers
    |--------------------------------------------------------------------------
    |
    | لیست مرتب درایورهای جایگزین.
    | اگر درایور پیش‌فرض به دلیل خطای اتصال یا پیکربندی ناموفق باشد،
    | سیستم به ترتیب هر درایور را امتحان می‌کند تا یکی موفق شود.
    |
    | مثال: ['kavenegar', 'melipayamak']
    |
    */

    'failover' => [],

    /*
    |--------------------------------------------------------------------------
    | SMS Drivers
    |--------------------------------------------------------------------------
    |
    | تعریف هر درایور با کلاس و credentials مربوطه.
    |
    | هر کلاس درایور باید اینترفیس SmsDriver را پیاده‌سازی کند.
    | به صورت اختیاری می‌تواند DeliveryReportFetcher را هم پیاده‌سازی کند.
    |
    | 'class'       => نام کامل کلاس درایور (FQCN)
    | 'credentials' => آرایه‌ی تنظیمات که به سازنده‌ی درایور پاس داده می‌شود
    |
    */

    'drivers' => [

        // درایور خالی برای توسعه و تست — هیچ پیامکی ارسال نمی‌کند
        'null' => [
            'class'       => \Karnoweb\SmsSender\Drivers\NullDriver::class,
            'credentials' => [],
        ],

        // نمونه: درایور کاوه‌نگار
        // 'kavenegar' => [
        //     'class'       => \App\SmsDrivers\KavenegarDriver::class,
        //     'credentials' => [
        //         'api_key'   => env('KAVENEGAR_API_KEY'),
        //         'sender'    => env('KAVENEGAR_SENDER', '10008663'),
        //     ],
        // ],

    ],

    /*
    |--------------------------------------------------------------------------
    | SMS Log Model
    |--------------------------------------------------------------------------
    |
    | مدل Eloquent که برای ذخیره‌ی لاگ پیامک‌ها استفاده می‌شود.
    | می‌توانید مدل خودتان را جایگزین کنید به شرطی که ساختار جدول یکسان باشد.
    |
    */

    'model' => \Karnoweb\SmsSender\Models\Sms::class,

    /*
    |--------------------------------------------------------------------------
    | SMS Table Name
    |--------------------------------------------------------------------------
    |
    | نام جدول دیتابیس برای ذخیره‌ی لاگ پیامک‌ها.
    | مدل پیش‌فرض پکیج از این مقدار استفاده می‌کند.
    |
    */

    'table' => 'sms_messages',

];
```

---

## ۳. `src/SmsServiceProvider.php`

```php
<?php

namespace Karnoweb\SmsSender;

use Illuminate\Contracts\Container\Container;
use Illuminate\Support\ServiceProvider;

class SmsServiceProvider extends ServiceProvider
{
    /**
     * ثبت سرویس‌ها در Container.
     *
     * - کانفیگ پیش‌فرض پکیج merge می‌شود تا کاربر فقط موارد دلخواه را override کند.
     * - SmsManager به صورت Singleton ثبت می‌شود چون:
     *   ۱. وابستگی‌هایش (Container) در طول یک Request تغییر نمی‌کنند.
     *   ۲. متد reset() بعد از هر send/checkStatus فراخوانی می‌شود پس state آلوده نمی‌ماند.
     */
    public function register(): void
    {
        $this->mergeConfigFrom(
            __DIR__ . '/../config/sms.php',
            'sms',
        );

        $this->app->singleton(SmsManager::class, function (Container $app): SmsManager {
            return new SmsManager($app);
        });
    }

    /**
     * عملیات Boot پکیج.
     *
     * فقط در محیط Console (مثلاً artisan) فایل‌ها قابل publish می‌شوند
     * تا در Runtime هیچ overhead اضافی ایجاد نشود.
     */
    public function boot(): void
    {
        if ($this->app->runningInConsole()) {
            $this->registerPublishing();
        }
    }

    /**
     * تعریف فایل‌های قابل publish.
     *
     * کاربر می‌تواند با دستورات زیر فایل‌ها را منتشر کند:
     *   php artisan vendor:publish --tag=sms-config
     *   php artisan vendor:publish --tag=sms-migrations
     */
    private function registerPublishing(): void
    {
        // انتشار فایل کانفیگ به مسیر config/sms.php اپلیکیشن
        $this->publishes([
            __DIR__ . '/../config/sms.php' => config_path('sms.php'),
        ], 'sms-config');

        // انتشار Migration ها به پوشه‌ی migrations اپلیکیشن
        $this->publishes([
            __DIR__ . '/../database/migrations' => database_path('migrations'),
        ], 'sms-migrations');
    }
}
```

---

## ۴. `src/Facades/Sms.php`

```php
<?php

namespace Karnoweb\SmsSender\Facades;

use Illuminate\Support\Facades\Facade;
use Karnoweb\SmsSender\SmsManager;

/**
 * Facade برای دسترسی ساده به SmsManager.
 *
 * به جای تزریق وابستگی یا app()->make(), می‌توان نوشت:
 *   Sms::message('سلام')->number('09120000000')->send();
 *
 * متدهای زیر از SmsManager پروکسی می‌شوند:
 *
 * @method static SmsManager message(string $message)
 * @method static SmsManager otp(\Karnoweb\SmsSender\Enums\SmsTemplateEnum $template)
 * @method static SmsManager input(string $key, string $value)
 * @method static SmsManager inputs(array $inputs)
 * @method static SmsManager number(string $phone)
 * @method static SmsManager numbers(array $phones)
 * @method static void send()
 * @method static array checkStatus()
 *
 * @see SmsManager
 */
class Sms extends Facade
{
    /**
     * کلید Binding در Container.
     *
     * Facade از این کلید برای resolve کردن instance واقعی استفاده می‌کند.
     * چون SmsManager با همین FQCN در ServiceProvider ثبت شده، مستقیماً resolve می‌شود.
     */
    protected static function getFacadeAccessor(): string
    {
        return SmsManager::class;
    }
}
```

---

## ۵. `src/SmsManager.php`

```php
<?php

namespace Karnoweb\SmsSender;

use Illuminate\Contracts\Container\Container;

/**
 * مدیر اصلی ارسال پیامک.
 *
 * این کلاس به عنوان یک Builder/Facade سطح بالا عمل می‌کند و مسئولیت‌های زیر را دارد:
 * - ساخت پیامک به صورت Fluent (قالب، ورودی، گیرنده)
 * - مدیریت درایورها و Failover خودکار
 * - ثبت لاگ در دیتابیس
 * - بررسی وضعیت تحویل
 *
 * نمونه استفاده:
 *   SmsManager::instance()
 *       ->message('کد تایید: 1234')
 *       ->number('09120000000')
 *       ->send();
 *
 * یا از طریق Facade:
 *   Sms::message('سلام')->number('09120000000')->send();
 *
 * نکته: بعد از هر send() یا checkStatus()، state داخلی reset می‌شود
 *        تا instance قابل استفاده مجدد باشد (مهم برای Singleton).
 */
class SmsManager
{
    /**
     * @param Container $container کانتینر لاراول برای resolve کردن درایورها و دسترسی به Config
     */
    public function __construct(
        protected readonly Container $container,
    ) {}

    /**
     * ساخت/دریافت instance از Container.
     *
     * این متد یک Shortcut برای مواردی است که Dependency Injection یا Facade
     * در دسترس نیست (مثلاً داخل یک Job قدیمی یا Helper function).
     *
     * در شرایط عادی، استفاده از Facade یا Constructor Injection ترجیح داده می‌شود.
     */
    public static function instance(): static
    {
        /** @var static $instance */
        $instance = app(static::class);

        return $instance;
    }
}
```

---

## ۶. `src/Drivers/NullDriver.php`

```php
<?php

namespace Karnoweb\SmsSender\Drivers;

use Karnoweb\SmsSender\Contracts\SmsDriver;

/**
 * درایور خالی (Null Object Pattern).
 *
 * هدف:
 * - در محیط توسعه (local) پیامک واقعی ارسال نشود.
 * - در تست‌ها بدون Mock کردن درایور واقعی، عملکرد SmsManager قابل تست باشد.
 * - به عنوان درایور پیش‌فرض در config/sms.php تعریف شده.
 *
 * این درایور هیچ عملیاتی انجام نمی‌دهد و هیچ Exception پرتاب نمی‌کند.
 */
class NullDriver implements SmsDriver
{
    /**
     * @param array<string, mixed> $config تنظیمات درایور (در اینجا استفاده نمی‌شود)
     */
    public function __construct(
        protected readonly array $config = [],
    ) {}

    /**
     * شبیه‌سازی ارسال پیامک بدون انجام هیچ عملیاتی.
     *
     * @param string $phone   شماره‌ی گیرنده
     * @param string $message متن پیامک
     */
    public function send(string $phone, string $message): void
    {
        // عمداً خالی — Null Object Pattern
    }
}
```

---

## ۷. `src/Contracts/SmsDriver.php` (پیش‌نیاز NullDriver)

> ⚠️ این فایل از نظر فازبندی متعلق به فاز ۲ است، اما چون `NullDriver` به آن وابسته است و کد بدون آن اجرا نمی‌شود، **حداقل اسکلت** آن را اینجا می‌سازیم.

```php
<?php

namespace Karnoweb\SmsSender\Contracts;

/**
 * قرارداد اصلی درایورهای SMS.
 *
 * هر درایور ارسال پیامک (کاوه‌نگار، ملی‌پیامک، و ...) باید این اینترفیس را
 * پیاده‌سازی کند تا SmsManager بتواند به صورت یکپارچه از آن استفاده کند.
 *
 * نکته: سازنده‌ی هر درایور باید یک پارامتر array $config بپذیرد
 *        که credentials و تنظیمات از فایل config/sms.php به آن پاس داده می‌شود.
 */
interface SmsDriver
{
    /**
     * ارسال یک پیامک به شماره‌ی مشخص.
     *
     * @param string $phone   شماره‌ی موبایل گیرنده (مثلاً '09120000000')
     * @param string $message متن نهایی پیامک
     *
     * @throws \Karnoweb\SmsSender\Exceptions\DriverConnectionException در صورت خطای ارتباطی
     */
    public function send(string $phone, string $message): void;
}
```

---

## ۸. `tests/TestCase.php`

```php
<?php

namespace Karnoweb\SmsSender\Tests;

use Karnoweb\SmsSender\SmsServiceProvider;
use Orchestra\Testbench\TestCase as BaseTestCase;

/**
 * کلاس پایه‌ی تست‌های پکیج.
 *
 * از Orchestra Testbench استفاده می‌کند تا محیط لاراول شبیه‌سازی شود
 * بدون نیاز به نصب کامل یک پروژه‌ی لاراولی.
 */
abstract class TestCase extends BaseTestCase
{
    /**
     * ثبت Service Provider پکیج در محیط تست.
     *
     * Testbench این متد را فراخوانی می‌کند تا بداند کدام Provider ها را بوت کند.
     */
    protected function getPackageProviders($app): array
    {
        return [
            SmsServiceProvider::class,
        ];
    }

    /**
     * ثبت Alias/Facade پکیج در محیط تست.
     */
    protected function getPackageAliases($app): array
    {
        return [
            'Sms' => \Karnoweb\SmsSender\Facades\Sms::class,
        ];
    }
}
```

---

## ۹. `tests/Feature/ServiceProviderTest.php`

```php
<?php

namespace Karnoweb\SmsSender\Tests\Feature;

use Karnoweb\SmsSender\Facades\Sms;
use Karnoweb\SmsSender\SmsManager;
use Karnoweb\SmsSender\Tests\TestCase;

/**
 * تست‌های صحت ثبت پکیج در Container لاراول.
 *
 * این تست‌ها تضمین می‌کنند که:
 * - Config به درستی merge شده
 * - SmsManager به صورت Singleton ثبت شده
 * - Facade به درستی resolve می‌شود
 * - درایور پیش‌فرض (null) معتبر است
 */
class ServiceProviderTest extends TestCase
{
    // ─── Config ────────────────────────────────────────────

    public function test_config_is_merged_with_default_values(): void
    {
        // اطمینان از اینکه کانفیگ پکیج در runtime در دسترس است
        $this->assertNotNull(config('sms.default'));
        $this->assertIsArray(config('sms.drivers'));
        $this->assertIsArray(config('sms.failover'));
        $this->assertNotNull(config('sms.model'));
        $this->assertNotNull(config('sms.table'));
    }

    public function test_default_driver_is_null_in_default_config(): void
    {
        // درایور پیش‌فرض باید 'null' باشد تا در محیط توسعه پیامک واقعی ارسال نشود
        $this->assertEquals('null', config('sms.default'));
    }

    public function test_null_driver_is_defined_in_drivers(): void
    {
        // درایور null باید در لیست درایورها تعریف شده باشد
        $drivers = config('sms.drivers');

        $this->assertArrayHasKey('null', $drivers);
        $this->assertArrayHasKey('class', $drivers['null']);
    }

    public function test_null_driver_class_exists(): void
    {
        // کلاس درایور null باید واقعاً وجود داشته باشد
        $class = config('sms.drivers.null.class');

        $this->assertTrue(class_exists($class), "Driver class [{$class}] does not exist.");
    }

    // ─── Container Binding ─────────────────────────────────

    public function test_manager_is_bound_in_container(): void
    {
        // SmsManager باید در Container قابل resolve باشد
        $this->assertTrue($this->app->bound(SmsManager::class));
    }

    public function test_manager_is_singleton(): void
    {
        // دو بار resolve کردن باید همان instance را برگرداند
        // این مهم است چون reset() بعد از هر عملیات فراخوانی می‌شود
        $first  = $this->app->make(SmsManager::class);
        $second = $this->app->make(SmsManager::class);

        $this->assertSame($first, $second);
    }

    public function test_manager_is_instance_of_sms_manager(): void
    {
        $manager = $this->app->make(SmsManager::class);

        $this->assertInstanceOf(SmsManager::class, $manager);
    }

    // ─── Facade ────────────────────────────────────────────

    public function test_facade_resolves_to_manager(): void
    {
        // Facade باید به همان SmsManager singleton اشاره کند
        $resolved = Sms::getFacadeRoot();

        $this->assertInstanceOf(SmsManager::class, $resolved);
    }

    public function test_facade_resolves_same_singleton(): void
    {
        // Facade و Container باید یک instance یکسان برگردانند
        $fromFacade     = Sms::getFacadeRoot();
        $fromContainer  = $this->app->make(SmsManager::class);

        $this->assertSame($fromFacade, $fromContainer);
    }

    // ─── Static Instance Helper ────────────────────────────

    public function test_static_instance_returns_manager(): void
    {
        $instance = SmsManager::instance();

        $this->assertInstanceOf(SmsManager::class, $instance);
    }

    public function test_static_instance_returns_same_singleton(): void
    {
        $instance  = SmsManager::instance();
        $container = $this->app->make(SmsManager::class);

        $this->assertSame($instance, $container);
    }
}
```

---

## ✅ چک‌لیست فاز ۱

| آیتم | وضعیت |
|---|---|
| `composer.json` — namespace `Karnoweb\SmsSender`, auto-discovery | ✅ |
| `config/sms.php` — default, failover, drivers, model, table | ✅ |
| `SmsServiceProvider` — singleton bind, merge config, publish | ✅ |
| `Sms` Facade — PHPDoc کامل | ✅ |
| `SmsManager` — اسکلت با `instance()` | ✅ |
| `SmsDriver` Contract — حداقل اسکلت (پیش‌نیاز NullDriver) | ✅ |
| `NullDriver` — Null Object Pattern | ✅ |
| `TestCase` پایه با Testbench | ✅ |
| `ServiceProviderTest` — ۹ تست جامع | ✅ |
| کامنت‌های فارسی توضیحی در همه فایل‌ها | ✅ |

---
